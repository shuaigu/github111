{"version":3,"file":"userRoleManage.js","sources":["subPages/userRoleManage/userRoleManage.vue","../../软件/HBuilderX/HBuilderX/plugins/uniapp-cli-vite/uniPage:/c3ViUGFnZXNcdXNlclJvbGVNYW5hZ2VcdXNlclJvbGVNYW5hZ2UudnVl"],"sourcesContent":["<script setup>\r\n\timport { ref, onMounted } from 'vue';\r\n\t\r\n\tconst userId = ref('');\r\n\tconst userInfo = ref(null);\r\n\tconst loading = ref(true);\r\n\t\r\n\t// 定义所有可用角色\r\n\tconst allRoles = ref([\r\n\t\t{ id: 'admin', name: '管理员', description: '拥有系统管理权限' },\r\n\t\t{ id: 'vip', name: 'VIP用户', description: '拥有特殊内容访问权限' },\r\n\t\t{ id: 'editor', name: '编辑', description: '可以编辑和发布内容' },\r\n\t\t{ id: 'reviewer', name: '审核员', description: '可以审核内容' },\r\n\t\t{ id: 'customer', name: '客服', description: '处理用户反馈' },\r\n\t\t{ id: 'user', name: '普通用户', description: '基础用户权限' }\r\n\t]);\r\n\t\r\n\t// 用户API\r\n\tconst userApi = uniCloud.importObject('user', { customUI: true });\r\n\t\r\n\t// 获取用户详情\r\n\tconst getUserDetail = async () => {\r\n\t\ttry {\r\n\t\t\tloading.value = true;\r\n\t\t\tconst result = await userApi.getUserById(userId.value);\r\n\t\t\tuserInfo.value = result.data;\r\n\t\t\t\r\n\t\t\t// 确保用户至少有 user 角色\r\n\t\t\tif (!userInfo.value.role) {\r\n\t\t\t\tuserInfo.value.role = ['user'];\r\n\t\t\t} else if (!userInfo.value.role.includes('user')) {\r\n\t\t\t\tuserInfo.value.role.push('user');\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '获取用户信息失败: ' + e.message,\r\n\t\t\t\ticon: 'none'\r\n\t\t\t});\r\n\t\t} finally {\r\n\t\t\tloading.value = false;\r\n\t\t}\r\n\t};\r\n\t\r\n\t// 切换角色\r\n\tconst toggleRole = async (roleId) => {\r\n\t\t// 不允许移除 user 角色\r\n\t\tif (roleId === 'user' && userInfo.value.role && userInfo.value.role.includes('user')) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '不能移除普通用户角色',\r\n\t\t\t\ticon: 'none'\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\tuni.showLoading({\r\n\t\t\t\ttitle: '处理中...'\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t// 检查用户是否已有该角色\r\n\t\t\tconst hasRole = userInfo.value.role && userInfo.value.role.includes(roleId);\r\n\t\t\t\r\n\t\t\t// 调用云函数更新用户角色\r\n\t\t\tawait userApi.updateUserRole({\r\n\t\t\t\tuserId: userId.value,\r\n\t\t\t\taction: hasRole ? 'remove' : 'add',\r\n\t\t\t\trole: roleId\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t// 更新本地数据\r\n\t\t\tif (hasRole) {\r\n\t\t\t\t// 移除角色\r\n\t\t\t\tconst index = userInfo.value.role.indexOf(roleId);\r\n\t\t\t\tuserInfo.value.role.splice(index, 1);\r\n\t\t\t} else {\r\n\t\t\t\t// 添加角色\r\n\t\t\t\tif (!userInfo.value.role) {\r\n\t\t\t\t\tuserInfo.value.role = [];\r\n\t\t\t\t}\r\n\t\t\t\tuserInfo.value.role.push(roleId);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: hasRole ? '已移除角色' : '已添加角色',\r\n\t\t\t\ticon: 'success'\r\n\t\t\t});\r\n\t\t} catch (e) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '操作失败: ' + e.message,\r\n\t\t\t\ticon: 'none'\r\n\t\t\t});\r\n\t\t} finally {\r\n\t\t\tuni.hideLoading();\r\n\t\t}\r\n\t};\r\n\t\r\n\t// 检查用户是否有特定角色\r\n\tconst hasRole = (roleId) => {\r\n\t\treturn userInfo.value && userInfo.value.role && userInfo.value.role.includes(roleId);\r\n\t};\r\n\t\r\n\tonMounted(() => {\r\n\t\tconst pages = getCurrentPages();\r\n\t\tconst currentPage = pages[pages.length - 1];\r\n\t\tconst options = currentPage.$page?.options;\r\n\t\t\r\n\t\tif (options && options.id) {\r\n\t\t\tuserId.value = options.id;\r\n\t\t\tgetUserDetail();\r\n\t\t} else {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '用户ID不存在',\r\n\t\t\t\ticon: 'none'\r\n\t\t\t});\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tuni.navigateBack();\r\n\t\t\t}, 1500);\r\n\t\t}\r\n\t});\r\n</script>\r\n\r\n<template>\r\n\t<view class=\"role-manage\">\r\n\t\t<view v-if=\"loading\" class=\"loading\">\r\n\t\t\t<uni-load-more status=\"loading\" :contentText=\"{ contentdown: '加载中...' }\"></uni-load-more>\r\n\t\t</view>\r\n\t\t\r\n\t\t<view v-else-if=\"userInfo\" class=\"role-container\">\r\n\t\t\t<view class=\"user-info\">\r\n\t\t\t\t<image class=\"avatar\" :src=\"userInfo.avatarUrl || '/static/images/default-avatar.png'\" mode=\"aspectFill\"></image>\r\n\t\t\t\t<view class=\"info\">\r\n\t\t\t\t\t<view class=\"name\">{{userInfo.nickName || '未设置昵称'}}</view>\r\n\t\t\t\t\t<view class=\"mobile\">{{userInfo.mobile}}</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t\t\r\n\t\t\t<view class=\"role-list\">\r\n\t\t\t\t<view class=\"section-title\">角色管理</view>\r\n\t\t\t\t<view class=\"role-item\" v-for=\"role in allRoles\" :key=\"role.id\"\r\n\t\t\t\t\t:class=\"{'role-item-user': role.id === 'user'}\">\r\n\t\t\t\t\t<view class=\"role-info\">\r\n\t\t\t\t\t\t<view class=\"role-name\">{{role.name}}</view>\r\n\t\t\t\t\t\t<view class=\"role-desc\">{{role.description}}</view>\r\n\t\t\t\t\t\t<view v-if=\"role.id === 'user'\" class=\"role-default-badge\">默认</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view :class=\"{'switch-disabled': role.id === 'user' && hasRole('user')}\">\r\n\t\t\t\t\t\t<switch :checked=\"hasRole(role.id)\" color=\"#399bfe\" @change=\"toggleRole(role.id)\" \r\n\t\t\t\t\t\t\t:disabled=\"role.id === 'user' && hasRole('user')\" />\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t\t\r\n\t\t\t<view class=\"tips\">\r\n\t\t\t\t<view class=\"tip-item\">* 角色变更将立即生效</view>\r\n\t\t\t\t<view class=\"tip-item\">* 请谨慎分配管理员权限</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t\r\n\t\t<view v-else class=\"no-data\">\r\n\t\t\t<text>用户信息不存在</text>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<style lang=\"scss\" scoped>\r\n\t@import \"@/style/common.scss\";\r\n\t\r\n\t.role-manage {\r\n\t\t@include pagesBaseStyle;\r\n\t\tpadding: 20rpx;\r\n\t\t\r\n\t\t.loading, .no-data {\r\n\t\t\tdisplay: flex;\r\n\t\t\tjustify-content: center;\r\n\t\t\talign-items: center;\r\n\t\t\theight: 300rpx;\r\n\t\t\tbackground-color: #fff;\r\n\t\t\tborder-radius: 12rpx;\r\n\t\t\t\r\n\t\t\t.no-data {\r\n\t\t\t\tcolor: #999;\r\n\t\t\t\tfont-size: 28rpx;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t.role-container {\r\n\t\t\tbackground-color: #fff;\r\n\t\t\tborder-radius: 12rpx;\r\n\t\t\toverflow: hidden;\r\n\t\t\t\r\n\t\t\t.user-info {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tpadding: 30rpx;\r\n\t\t\t\tborder-bottom: 1px solid #eee;\r\n\t\t\t\t\r\n\t\t\t\t.avatar {\r\n\t\t\t\t\twidth: 100rpx;\r\n\t\t\t\t\theight: 100rpx;\r\n\t\t\t\t\tborder-radius: 50%;\r\n\t\t\t\t\tmargin-right: 20rpx;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.info {\r\n\t\t\t\t\t.name {\r\n\t\t\t\t\t\tfont-size: 32rpx;\r\n\t\t\t\t\t\tcolor: #333;\r\n\t\t\t\t\t\tmargin-bottom: 10rpx;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t.mobile {\r\n\t\t\t\t\t\tfont-size: 26rpx;\r\n\t\t\t\t\t\tcolor: #999;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t.role-list {\r\n\t\t\t\tpadding: 20rpx;\r\n\t\t\t\t\r\n\t\t\t\t.section-title {\r\n\t\t\t\t\tfont-size: 32rpx;\r\n\t\t\t\t\tfont-weight: bold;\r\n\t\t\t\t\tcolor: #333;\r\n\t\t\t\t\tmargin-bottom: 20rpx;\r\n\t\t\t\t\tpadding-left: 20rpx;\r\n\t\t\t\t\tborder-left: 6rpx solid #399bfe;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.role-item {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tjustify-content: space-between;\r\n\t\t\t\t\talign-items: center;\r\n\t\t\t\t\tpadding: 20rpx 0;\r\n\t\t\t\t\tborder-bottom: 1px solid #eee;\r\n\t\t\t\t\t\r\n\t\t\t\t\t&:last-child {\r\n\t\t\t\t\t\tborder-bottom: none;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t&.role-item-user {\r\n\t\t\t\t\t\tbackground-color: #f8f8f8;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t.role-info {\r\n\t\t\t\t\t\t.role-name {\r\n\t\t\t\t\t\t\tfont-size: 28rpx;\r\n\t\t\t\t\t\t\tcolor: #333;\r\n\t\t\t\t\t\t\tmargin-bottom: 6rpx;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t.role-desc {\r\n\t\t\t\t\t\t\tfont-size: 24rpx;\r\n\t\t\t\t\t\t\tcolor: #999;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t.role-default-badge {\r\n\t\t\t\t\t\t\tdisplay: inline-block;\r\n\t\t\t\t\t\t\tfont-size: 20rpx;\r\n\t\t\t\t\t\t\tpadding: 2rpx 10rpx;\r\n\t\t\t\t\t\t\tbackground-color: #e1f5fe;\r\n\t\t\t\t\t\t\tcolor: #399bfe;\r\n\t\t\t\t\t\t\tborder-radius: 20rpx;\r\n\t\t\t\t\t\t\tmargin-top: 6rpx;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t.switch-disabled {\r\n\t\t\t\t\t\topacity: 0.6;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t.tips {\r\n\t\t\t\tpadding: 20rpx;\r\n\t\t\t\tbackground-color: #f9f9f9;\r\n\t\t\t\t\r\n\t\t\t\t.tip-item {\r\n\t\t\t\t\tfont-size: 24rpx;\r\n\t\t\t\t\tcolor: #999;\r\n\t\t\t\t\tline-height: 1.6;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</style> ","import MiniProgramPage from 'D:/代码测试/wx2/subPages/userRoleManage/userRoleManage.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uniCloud","uni","hasRole","onMounted"],"mappings":"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"}