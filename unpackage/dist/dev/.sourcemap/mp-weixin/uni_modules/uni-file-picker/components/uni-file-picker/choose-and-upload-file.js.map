{"version":3,"file":"choose-and-upload-file.js","sources":["uni_modules/uni-file-picker/components/uni-file-picker/choose-and-upload-file.js"],"sourcesContent":["'use strict';\n\nconst ERR_MSG_OK = 'chooseAndUploadFile:ok';\nconst ERR_MSG_FAIL = 'chooseAndUploadFile:fail';\n\nfunction chooseImage(opts) {\n\tconst {\n\t\tcount,\n\t\tsizeType = ['original', 'compressed'],\n\t\tsourceType,\n\t\textension\n\t} = opts\n\treturn new Promise((resolve, reject) => {\n\t\t// 微信由于旧接口不再维护，针对微信小程序平台改用chooseMedia接口\n\t\t// #ifdef MP-WEIXIN\n\t\tuni.chooseMedia({\n\t\t\tcount,\n\t\t\tsizeType,\n\t\t\tsourceType,\n\t\t\tmediaType: ['image'],\n\t\t\textension,\n\t\t\tsuccess(res) {\n\t\t\t\tres.tempFiles.forEach(item => {\n\t\t\t\t\titem.path = item.tempFilePath;\n\t\t\t\t})\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res, 'image'));\n\t\t\t},\n\t\t\tfail(res) {\n\t\t\t\treject({\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseImage:fail', ERR_MSG_FAIL),\n\t\t\t\t});\n\t\t\t},\n\t\t})\n\t\t// #endif\n\t\t// #ifndef MP-WEIXIN\n\t\tuni.chooseImage({\n\t\t\tcount,\n\t\t\tsizeType,\n\t\t\tsourceType,\n\t\t\textension,\n\t\t\tsuccess(res) {\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res, 'image'));\n\t\t\t},\n\t\t\tfail(res) {\n\t\t\t\treject({\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseImage:fail', ERR_MSG_FAIL),\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t\t// #endif\n\n\t});\n}\n\nfunction chooseVideo(opts) {\n\tconst {\n\t\tcount,\n\t\tcamera,\n\t\tcompressed,\n\t\tmaxDuration,\n\t\tsourceType,\n\t\textension\n\t} = opts;\n\treturn new Promise((resolve, reject) => {\n\t\t// 微信由于旧接口不再维护，针对微信小程序平台改用chooseMedia接口\n\t\t// #ifdef MP-WEIXIN\n\t\tuni.chooseMedia({\n\t\t\tcount,\n\t\t\tcompressed,\n\t\t\tmaxDuration,\n\t\t\tsourceType,\n\t\t\textension,\n\t\t\tmediaType: ['video'],\n\t\t\tsuccess(res) {\n\t\t\t\tconst {\n\t\t\t\t\ttempFiles,\n\t\t\t\t} = res;\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes({\n\t\t\t\t\terrMsg: 'chooseVideo:ok',\n\t\t\t\t\ttempFiles: tempFiles.map(item => {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tname: item.name || '',\n\t\t\t\t\t\t\tpath: item.tempFilePath,\n\t\t\t\t\t\t\tthumbTempFilePath: item.thumbTempFilePath,\n\t\t\t\t\t\t\tsize:item.size,\n\t\t\t\t\t\t\ttype: (res.tempFile && res.tempFile.type) || '',\n\t\t\t\t\t\t\twidth:item.width,\n\t\t\t\t\t\t\theight:item.height,\n\t\t\t\t\t\t\tduration:item.duration,\n\t\t\t\t\t\t\tfileType: 'video',\n\t\t\t\t\t\t\tcloudPath: '',\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t}, 'video'));\n\t\t\t},\n\t\t\tfail(res) {\n\t\t\t\treject({\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseVideo:fail', ERR_MSG_FAIL),\n\t\t\t\t});\n\t\t\t},\n\t\t})\n\t\t// #endif\n\t\t// #ifndef MP-WEIXIN\n\t\tuni.chooseVideo({\n\t\t\tcamera,\n\t\t\tcompressed,\n\t\t\tmaxDuration,\n\t\t\tsourceType,\n\t\t\textension,\n\t\t\tsuccess(res) {\n\t\t\t\tconst {\n\t\t\t\t\ttempFilePath,\n\t\t\t\t\tduration,\n\t\t\t\t\tsize,\n\t\t\t\t\theight,\n\t\t\t\t\twidth\n\t\t\t\t} = res;\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes({\n\t\t\t\t\terrMsg: 'chooseVideo:ok',\n\t\t\t\t\ttempFilePaths: [tempFilePath],\n\t\t\t\t\ttempFiles: [{\n\t\t\t\t\t\tname: (res.tempFile && res.tempFile.name) || '',\n\t\t\t\t\t\tpath: tempFilePath,\n\t\t\t\t\t\tsize,\n\t\t\t\t\t\ttype: (res.tempFile && res.tempFile.type) || '',\n\t\t\t\t\t\twidth,\n\t\t\t\t\t\theight,\n\t\t\t\t\t\tduration,\n\t\t\t\t\t\tfileType: 'video',\n\t\t\t\t\t\tcloudPath: '',\n\t\t\t\t\t}, ],\n\t\t\t\t}, 'video'));\n\t\t\t},\n\t\t\tfail(res) {\n\t\t\t\treject({\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseVideo:fail', ERR_MSG_FAIL),\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t\t// #endif\n\t});\n}\n\nfunction chooseAll(opts) {\n\tconst {\n\t\tcount,\n\t\textension\n\t} = opts;\n\treturn new Promise((resolve, reject) => {\n\t\tlet chooseFile = uni.chooseFile;\n\t\tif (typeof wx !== 'undefined' &&\n\t\t\ttypeof wx.chooseMessageFile === 'function') {\n\t\t\tchooseFile = wx.chooseMessageFile;\n\t\t}\n\t\tif (typeof chooseFile !== 'function') {\n\t\t\treturn reject({\n\t\t\t\terrMsg: ERR_MSG_FAIL + ' 请指定 type 类型，该平台仅支持选择 image 或 video。',\n\t\t\t});\n\t\t}\n\t\tchooseFile({\n\t\t\ttype: 'all',\n\t\t\tcount,\n\t\t\textension,\n\t\t\tsuccess(res) {\n\t\t\t\tresolve(normalizeChooseAndUploadFileRes(res));\n\t\t\t},\n\t\t\tfail(res) {\n\t\t\t\treject({\n\t\t\t\t\terrMsg: res.errMsg.replace('chooseFile:fail', ERR_MSG_FAIL),\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t});\n}\n\nfunction normalizeChooseAndUploadFileRes(res, fileType) {\n\tres.tempFiles.forEach((item, index) => {\n\t\tif (!item.name) {\n\t\t\titem.name = item.path.substring(item.path.lastIndexOf('/') + 1);\n\t\t}\n\t\tif (fileType) {\n\t\t\titem.fileType = fileType;\n\t\t}\n\t\titem.cloudPath =\n\t\t\tDate.now() + '_' + index + item.name.substring(item.name.lastIndexOf('.'));\n\t});\n\tif (!res.tempFilePaths) {\n\t\tres.tempFilePaths = res.tempFiles.map((file) => file.path);\n\t}\n\treturn res;\n}\n\nfunction uploadCloudFiles(files, max = 5, onUploadProgress) {\n\tfiles = JSON.parse(JSON.stringify(files))\n\tconst len = files.length\n\tlet count = 0\n\tlet self = this\n\treturn new Promise(resolve => {\n\t\twhile (count < max) {\n\t\t\tnext()\n\t\t}\n\n\t\tfunction next() {\n\t\t\tlet cur = count++\n\t\t\tif (cur >= len) {\n\t\t\t\t!files.find(item => !item.url && !item.errMsg) && resolve(files)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconst fileItem = files[cur]\n\t\t\tconst index = self.files.findIndex(v => v.uuid === fileItem.uuid)\n\t\t\tfileItem.url = ''\n\t\t\tdelete fileItem.errMsg\n\n\t\t\tuniCloud\n\t\t\t\t.uploadFile({\n\t\t\t\t\tfilePath: fileItem.path,\n\t\t\t\t\tcloudPath: fileItem.cloudPath,\n\t\t\t\t\tfileType: fileItem.fileType,\n\t\t\t\t\tonUploadProgress: res => {\n\t\t\t\t\t\tres.index = index\n\t\t\t\t\t\tonUploadProgress && onUploadProgress(res)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(res => {\n\t\t\t\t\tfileItem.url = res.fileID\n\t\t\t\t\tfileItem.index = index\n\t\t\t\t\tif (cur < len) {\n\t\t\t\t\t\tnext()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(res => {\n\t\t\t\t\tfileItem.errMsg = res.errMsg || res.message\n\t\t\t\t\tfileItem.index = index\n\t\t\t\t\tif (cur < len) {\n\t\t\t\t\t\tnext()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t}\n\t})\n}\n\n\n\n\n\nfunction uploadFiles(choosePromise, {\n\tonChooseFile,\n\tonUploadProgress\n}) {\n\treturn choosePromise\n\t\t.then((res) => {\n\t\t\tif (onChooseFile) {\n\t\t\t\tconst customChooseRes = onChooseFile(res);\n\t\t\t\tif (typeof customChooseRes !== 'undefined') {\n\t\t\t\t\treturn Promise.resolve(customChooseRes).then((chooseRes) => typeof chooseRes === 'undefined' ?\n\t\t\t\t\t\tres : chooseRes);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn res;\n\t\t})\n\t\t.then((res) => {\n\t\t\tif (res === false) {\n\t\t\t\treturn {\n\t\t\t\t\terrMsg: ERR_MSG_OK,\n\t\t\t\t\ttempFilePaths: [],\n\t\t\t\t\ttempFiles: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn res\n\t\t})\n}\n\nfunction chooseAndUploadFile(opts = {\n\ttype: 'all'\n}) {\n\tif (opts.type === 'image') {\n\t\treturn uploadFiles(chooseImage(opts), opts);\n\t} else if (opts.type === 'video') {\n\t\treturn uploadFiles(chooseVideo(opts), opts);\n\t}\n\treturn uploadFiles(chooseAll(opts), opts);\n}\n\nexport {\n\tchooseAndUploadFile,\n\tuploadCloudFiles\n};\n"],"names":["uni","wx","uniCloud"],"mappings":"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"}