"use strict";const e=require("../../common/vendor.js"),t={__name:"articleDetail-choujia",props:{commenters:{type:Array,default:()=>[]},articleId:{type:String,default:""}},emits:["lottery-result","show-comment","position-updated"],setup(t,{expose:o,emit:n}){const a=t;e.ref(!0);const r=n,i=e.reactive([]),l=e.reactive(Array(9).fill(null)),s=e.ref(!1),u=e.ref(!1),c=e.computed((()=>{const e=[];for(let t=0;t<9;t++)l[t]?e.push(l[t]):e.push({});return e})),d=e.computed((()=>{if(0===i.length)return 0;return(100/i.length).toFixed(2)})),v=e.ref(-1),f=e.ref(-1),m=e.ref(!1),g=e.ref(!1),h=e.ref(null),p=e.ref([]),w=e.computed((()=>{let e=0;for(let t=0;t<9;t++)l[t]&&(l[t].avatarUrl||l[t]._id)&&e++;return e})),y=e.ref(""),_=e.ref(!1);e.watch((()=>a.commenters),(e=>{e&&e.length>0&&(m.value=!1,h.value=null,f.value=-1,T())}),{deep:!0});let x=null;const I=e=>e?e.nickName||e.mobile||"匿名用户":"",S=async()=>{if(_.value)return console.log("已经加载过位置数据，跳过重复加载"),!0;if(!a.articleId)return console.warn("没有文章ID，无法加载位置数据"),!1;try{s.value=!0;const t=e.nr.importObject("choujiangWx"),o=await t.getGridPositions(a.articleId);if(o.success&&o.gridPositions){console.log("从云端加载的位置数据:",o.gridPositions);for(let e=0;e<9;e++)l[e]=null;return o.gridPositions.forEach(((e,t)=>{e&&t<9&&(l[t]=e)})),_.value=!0,!0}return console.log("没有找到保存的位置数据或加载失败"),!1}catch(t){return console.error("加载位置数据失败:",t),!1}finally{s.value=!1}},b=async()=>{if(!a.articleId)return console.warn("没有文章ID，无法保存位置数据"),!1;try{if(u.value)return!1;u.value=!0;const t=[...l],o=e.nr.importObject("choujiangWx"),n=await o.saveGridPositions({articleId:a.articleId,positions:t});return n.success?(console.log("位置数据保存成功"),!0):(console.warn("位置数据保存失败:",n.message),!1)}catch(t){return console.error("保存位置数据失败:",t),!1}finally{u.value=!1}},T=async()=>{try{i.length=0;[...a.commenters].slice(0,9).forEach((e=>{i.push(e)}));if(!(await S())){const e=new Set,t=new Map;for(let n=0;n<9;n++)l[n]&&l[n]._id&&(e.add(n),t.set(l[n]._id,n));i.forEach((o=>{if(o._id&&t.has(o._id)){const n=t.get(o._id);l[n]=o,e.add(n)}}));let o=0;i.forEach((n=>{if(n._id&&!t.has(n._id)){for(;o<9&&e.has(o);)o++;o<9&&(l[o]=n,e.add(o),o++)}})),b()}}catch(t){console.error("更新用户展示失败:",t),e.index.showToast({title:"初始化失败，请重试",icon:"none"})}},D=T;o({updatePosition:async(e,t)=>{if(e>=0&&e<9){const o=[...l];l[e]=t;const n=i.findIndex((e=>e._id===t._id||e.user_id===t.user_id&&e.user_id));-1===n?i.push(t):i[n]=t;for(let e=0;e<9;e++)l[e]!==o[e]&&(l[e]=l[e]);await b(),r("position-updated",{position:e,userData:t})}},getPositionById:function(e){if(!e)return-1;for(let t=0;t<9;t++)if(l[t]&&l[t]._id===e)return t;return-1},clearPosition:async function(e){if(e>=0&&e<9){const t=[...l];l[e]={};for(let e=0;e<9;e++)l[e]!==t[e]&&(l[e]=l[e]);return function(){i.length=0;for(let e=0;e<9;e++)if(l[e]&&l[e]._id){-1===i.findIndex((t=>t._id===l[e]._id))&&i.push(l[e])}}(),await b(),!0}return!1}});const j=()=>{if(!g.value)return;x&&(clearTimeout(x),x=null),g.value=!1,v.value=f.value;const e=new Date,t=e.getFullYear(),o=(e.getMonth()+1).toString().padStart(2,"0"),n=e.getDate().toString().padStart(2,"0"),a=e.getHours().toString().padStart(2,"0"),r=e.getMinutes().toString().padStart(2,"0");y.value=`${t}年${o}月${n}日 ${a}:${r}`,m.value=!0,h.value&&$(h.value)},M=()=>{(async()=>{if(g.value)return j();if(0!==a.commenters.length){g.value=!0,v.value=-1,f.value=-1,h.value=null,m.value=!1;try{let o={},n="";try{if(e.index.getAppBaseInfo){const t=e.index.getAppBaseInfo();o={platform:t.platform,osName:t.osName,appVersion:t.appVersion}}else{const t=e.index.getSystemInfoSync();o={platform:t.platform,osName:t.osName||t.system}}n=(e.index.getLaunchOptionsSync?e.index.getLaunchOptionsSync():{}).scene||""}catch(t){console.error("获取系统信息失败",t)}const r={platformInfo:o,scene:n,time:Date.now(),isLotteryAction:!0,equalProbability:!0},l=e.nr.importObject("choujiangWx"),s=await l.doLottery({commenters:i,userId:e.index.getStorageSync("userId")||"",userInfo:r,articleId:a.articleId});if(!s.success)throw new Error(s.message||"抽奖失败");h.value=s.winner,f.value=s.winnerIndex<9?s.winnerIndex:s.winnerIndex%9,p.value=s.probabilityInfo||[],N()}catch(o){console.error("抽奖执行失败:",o),e.index.showToast({title:"抽奖失败，请重试",icon:"none"}),g.value=!1}}else e.index.showToast({title:"暂无评论者参与",icon:"none"})})()},N=()=>{x&&clearTimeout(x);let e=120,t=v.value,o=0;const n=Date.now(),a=()=>{if(!g.value)return;x&&clearTimeout(x),o=Date.now()-n;const r=o/2e3,i=(Math.cos(r)+1)/2;e=100+40*i,t=(t+1)%9,v.value=t,x=setTimeout(a,Math.floor(e))};a()},P=()=>{m.value=!1,g.value=!1,v.value=-1},k=e=>{if(!e)return"";const t=Date.now()-e;if(t<6e4)return"刚刚";if(t<36e5)return Math.floor(t/6e4)+"分钟前";if(t<864e5)return Math.floor(t/36e5)+"小时前";if(t<2592e6)return Math.floor(t/864e5)+"天前";const o=new Date(e);return`${o.getMonth()+1}月${o.getDate()}日`},$=async t=>{if(t&&"object"==typeof t)if(t.nickName)try{const o={...t,isLotteryResult:!0},n={article_id:a.articleId,winner_id:t._id||t.user_id||"",winner_name:t.nickName||"匿名用户",winner_avatar:t.avatarUrl||"",winner_mobile:t.mobile||"",winner_content:t.content||"",winner_index:f.value,draw_time:Date.now(),participant_count:i.length||0},l=e.nr.importObject("choujiangWx"),s=await l.saveLotteryResult(n);if(!s||!s.success)throw console.error("抽奖结果保存失败:",(null==s?void 0:s.message)||"未知错误"),new Error((null==s?void 0:s.message)||"抽奖结果保存失败");console.log("抽奖结果保存成功:",s),m.value=!0,g.value=!1,r("lottery-result",o)}catch(o){console.error("保存抽奖结果出错:",o),e.index.showToast({title:"抽奖完成，但结果保存失败",icon:"none",duration:2e3}),m.value=!0,g.value=!1,r("lottery-result",t)}else console.error("抽奖结果缺少用户信息:",t),g.value=!1,e.index.showToast({title:"抽奖结果异常",icon:"none"});else console.error("抽奖结果无效:",t),g.value=!1,e.index.showToast({title:"抽奖结果无效",icon:"none"})};return e.onMounted((async()=>{let e=!1;for(let t=0;t<9;t++)if(null!==l[t]){e=!0;break}if(!e)for(let t=0;t<9;t++)l[t]=null;return await S()||D(),()=>{x&&(clearTimeout(x),x=null)}})),(t,o)=>e.e({a:e.t(w.value),b:w.value<9},w.value<9?{c:e.t(9-w.value)}:{},{d:e.f(c.value,((t,o,n)=>e.e({a:t.avatarUrl},t.avatarUrl?{b:t.avatarUrl}:{c:e.o((t=>(t=>(console.log("触发点击参与事件，位置索引:",t),g.value?(console.log("当前正在抽奖中，不能参与"),void e.index.showToast({title:"抽奖进行中，请稍后",icon:"none"})):m.value?(console.log("已显示抽奖结果，不能再参与"),void e.index.showToast({title:"抽奖已完成",icon:"none"})):l[t]&&l[t]._id?(console.log("该位置已有用户数据，无法修改"),void e.index.showToast({title:"该位置已被占用",icon:"none"})):(console.log("发送评论事件到父组件，位置:",t),void r("show-comment",{position:t}))))(o)),o)},{d:t.nickName},t.nickName?{e:e.t(t.nickName)}:t._id?{g:e.t(I(t))}:{},{f:t._id,h:o,i:e.n({active:v.value===o,winner:f.value===o&&m.value})}))),e:e.t(d.value),f:e.t(g.value?"停止抽奖":"开始抽奖"),g:e.o(M),h:g.value?1:"",i:m.value&&h.value},m.value&&h.value?e.e({j:h.value},h.value?e.e({k:e.t(y.value),l:h.value.avatarUrl||"/static/images/default-avatar.png",m:e.t(I(h.value)),n:h.value.create_time},h.value.create_time?{o:e.t(k(h.value.create_time))}:{}):{},{p:e.t(d.value),q:e.o(P)}):{},{r:e.gei(t,"")})}};wx.createComponent(t);
