"use strict";const e=require("../../common/vendor.js"),t=require("../../store/user.js"),i=require("../../utils/isLogin.js");require("../../store/authSwitch.js");const o={components:{},data:()=>({shareTitle:"",shareImageUrl:"",shareUserId:"",defaultShareImage:"/static/images/logo.png",dynamicShareImage:"",linkShareImage:"",videoUrl:"",videoVisible:!1,isVideoPlaying:!1,videoContext:null,userClosedVideo:!1,userArticleData:[],userArticleInfo:{avatarUrl:"/static/images/default-avatar.png",nickName:"加载中...",mobile:"未填写"},latestArticleImages:[],pageNo:1,pageSize:8,status:"more",isLoading:!1,hasMore:!0,loadMoreText:{contentdown:"上拉加载更多",contentrefresh:"加载中...",contentnomore:"~ 已经到底啦 ~"},userStore:null,avatarClickEnabled:!0,isRefreshing:!1,refreshStartTime:0,scrollToLowerTimer:null,isScrollLoading:!1,totalArticleCount:0,showFullScreenPopup:!1,videoUrlCache:[]}),props:{userId:String},computed:{articleTotal(){return this.totalArticleCount||0}},onLoad(i){i.userId&&(this.shareUserId=i.userId),this.userStore=t.useUserInfoStore(),this.getSendOnState(),this.getUserArticleCount(),this.getArticelList(!0).then((()=>{this.searchAllVideosOnLoad()})),e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]}),e.index.$on("viewCountUpdated",(e=>{this.updateLocalViewCount({articleId:e})})),e.index.$on("articleViewCountUpdated",(e=>{console.log("用户文章列表收到文章浏览量更新事件:",e),e&&e.articleId&&this.updateLocalViewCount(e)})),e.index.$on("avatarClickChanged",(e=>{console.log("用户文章列表页面收到头像点击状态变化事件:",e),this.avatarClickEnabled=e})),e.index.$on("globalRefresh",(e=>{console.log("用户文章列表收到全局刷新事件:",e),e&&e.pages&&e.pages.includes("userArticleList")&&(console.log("正在刷新用户文章列表..."),this.getUserArticleCount(),this.getArticelList(!0))})),this.preloadDefaultShareImage()},onUnload(){e.index.$off("viewCountUpdated"),e.index.$off("articleViewCountUpdated"),e.index.$off("avatarClickChanged"),e.index.$off("globalRefresh"),this.scrollToLowerTimer&&(clearTimeout(this.scrollToLowerTimer),this.scrollToLowerTimer=null)},beforeDestroy(){this.scrollToLowerTimer&&(clearTimeout(this.scrollToLowerTimer),this.scrollToLowerTimer=null)},onReachBottom(){console.log("原生触底事件被触发"),this.isScrollLoading||this.scrollToLowerTimer||this.scrolltolower()},methods:{async getSendOnState(){try{console.log("正在获取按钮状态...");const t=e.nr.importObject("sendOn",{customUI:!0}),i=await t.get();if(i&&i.data&&i.data.length>0){const e=void 0===i.data[0].avatarClick||i.data[0].avatarClick;this.avatarClickEnabled=e,console.log("头像点击状态:",this.avatarClickEnabled)}else console.error("获取按钮状态失败: 数据格式不正确")}catch(t){console.error("获取按钮状态失败:",t)}},async getUserArticleCount(){if(this.userId){console.log("通过云对象请求文章总数，用户ID:",this.userId);try{const t=e.nr.importObject("articleWx",{customUI:!0}),i=await t.getArticleList(this.userId,1,1);return i&&void 0!==i.total?(this.totalArticleCount=i.total,console.log("云对象通过getArticleList获取到文章总数:",this.totalArticleCount),this.updateShareInfo(),this.totalArticleCount):(console.error("云对象获取文章总数失败: 未返回total字段"),null)}catch(t){return console.error("云对象获取文章总数出错:",t),this.totalArticleCount=0,console.log("云对象请求失败，设置文章总数为0"),null}}else console.log("用户ID不存在，无法获取文章总数")},preloadDefaultShareImage(){e.index.getImageInfo({src:this.defaultShareImage,success:e=>{console.log("默认分享图片预加载成功:",e),this.defaultShareImage=e.path,this.linkShareImage=e.path},fail:e=>{console.error("默认分享图片预加载失败:",e)}})},getShareInfo(){var e;if(this.userArticleInfo){const t=(null==(e=this.userArticleInfo)?void 0:e.nickName)||"用户";this.shareTitle=`我是${t}，这是我的第${this.articleTotal}条朋友圈，点击查看！`}this.shareUserId=this.userId||this.shareUserId;let t="";return t=this.dynamicShareImage?this.dynamicShareImage:this.userArticleInfo&&this.userArticleInfo.avatarUrl?this.userArticleInfo.avatarUrl:this.defaultShareImage,console.log("统一分享方法 - 使用图片:",t),{title:this.shareTitle||"更新了精彩动态，点击查看！",path:`/pages/userArticleList/userArticleList?userId=${this.shareUserId}`}},getTimelineShareInfo(){var e;if(this.userArticleInfo){const t=(null==(e=this.userArticleInfo)?void 0:e.nickName)||"用户";this.shareTitle=`我是${t}，这是我的第${this.articleTotal}条朋友圈，点击查看！`}this.shareUserId=this.userId||this.shareUserId;let t="";return t=this.dynamicShareImage?this.dynamicShareImage:this.userArticleInfo&&this.userArticleInfo.avatarUrl?this.userArticleInfo.avatarUrl:this.defaultShareImage,console.log("朋友圈分享 - 使用图片:",t),{title:this.shareTitle||"更新了精彩动态，点击查看！",query:`userId=${this.shareUserId}`,imageUrl:t}},updateShareInfo(){var e;if(this.userArticleInfo){const t=(null==(e=this.userArticleInfo)?void 0:e.nickName)||"用户";this.shareTitle=`我是${t}，这是我的第${this.articleTotal}条朋友圈，点击查看！`,this.shareUserId=this.userId||this.shareUserId,this.shareImageUrl=this.dynamicShareImage||this.defaultShareImage,console.log("更新分享信息:",{title:this.shareTitle,imageUrl:this.shareImageUrl,userId:this.shareUserId})}},async getArticelList(t=!1){return this.isLoading=!0,this.status="loading",t&&(this.pageNo=1,this.userArticleData=[]),new Promise((async(i,o)=>{try{const o=e.nr.importObject("articleWx",{customUI:!0}),s=await o.getArticleList(this.userId,this.pageNo,this.pageSize);if(s&&void 0!==s.total&&(this.totalArticleCount=s.total,console.log("获取到文章总数:",this.totalArticleCount)),s&&s.userInfo)this.userArticleInfo=s.userInfo,this.userId===this.userStore.userInfo.uid&&this.userStore.setUserInfo({...this.userStore.userInfo,nickName:s.userInfo.nickName||this.userStore.userInfo.nickName,avatarUrl:s.userInfo.avatarUrl||this.userStore.userInfo.avatarUrl}),this.$nextTick((()=>{this.updateShareInfo()}));else if(1===this.pageNo&&s&&s.data&&s.data.length>0){const e=s.data[0];this.userArticleInfo={avatarUrl:e.user_avatarUrl,nickName:e.user_nickName,mobile:e.user_mobile||"未填写"}}else 1===this.pageNo&&(this.userArticleInfo={});if(s&&s.data){let e=s.data;e=e.map((e=>(e.hasVideo=this.checkArticleHasVideo(e),e))),this.userArticleData=t?e:[...this.userArticleData,...e],this.userArticleData.forEach((e=>{!e.user_avatarUrl&&this.userArticleInfo.avatarUrl&&(e.user_avatarUrl=this.userArticleInfo.avatarUrl),!e.user_nickName&&this.userArticleInfo.nickName&&(e.user_nickName=this.userArticleInfo.nickName)})),this.hasMore=s.data.length>=this.pageSize,this.status=this.hasMore?"more":"noMore",this.$nextTick((()=>{this.updateShareInfo(),this.extractLatestArticleImages(),this.extractVideoFromArticles()}))}else t&&(this.userArticleData=[]),this.hasMore=!1,this.status="noMore";i()}catch(s){console.error("获取用户文章列表失败:",s),t&&(this.userArticleData=[]),this.userArticleInfo={},this.status="noMore",this.hasMore=!1,e.index.showToast({title:"获取数据失败，请重试",icon:"none"}),o(s)}finally{this.isLoading=!1,this.isRefreshing=!1}}))},scrolltolower(){if(console.log("触底加载被触发，状态:",{isLoading:this.isLoading,hasMore:this.hasMore,isScrollLoading:this.isScrollLoading}),this.isLoading||!this.hasMore||this.isScrollLoading)return void console.log("跳过加载: "+(this.isLoading?"正在加载中":this.isScrollLoading?"防抖期间":"没有更多数据"));this.isScrollLoading=!0,this.status="loading",this.scrollToLowerTimer&&clearTimeout(this.scrollToLowerTimer);let e=null;if(this.videoVisible&&this.videoContext){e={isPlaying:this.isVideoPlaying,position:0,visible:this.videoVisible};try{this.videoContext.pause(),e.position=this.videoContext.currentTime||0,e.isPlaying&&this.videoContext.play()}catch(t){console.error("保存视频状态时出错:",t)}}this.scrollToLowerTimer=setTimeout((()=>{console.log("开始加载更多数据 (防抖后)，保存的视频状态:",e),this.loadMoreData(e)}),500)},async loadMoreData(e=null){if(this.isLoading||!this.hasMore)return console.log("跳过加载更多:",{isLoading:this.isLoading,hasMore:this.hasMore}),void(this.isScrollLoading=!1);console.log(`开始加载第${this.pageNo+1}页数据，视频状态:`,e),this.status="loading",this.isLoading=!0;const t=Date.now();this.pageNo++;try{await this.getArticelList();const i=Date.now()-t;i<500&&await new Promise((e=>setTimeout(e,500-i))),console.log(`第${this.pageNo}页数据加载完成, 当前状态:`,{articleCount:this.userArticleData.length,hasMore:this.hasMore,status:this.status}),this.$nextTick((()=>{this.restoreVideoState(e)}))}catch(i){i&&"请求进行中"===i.message?console.log("忽略并发请求:",i.message):console.error("加载更多数据失败:",i),this.pageNo--,this.status="more",this.$nextTick((()=>{this.restoreVideoState(e)}))}finally{this.isLoading=!1,this.isScrollLoading=!1}},restoreVideoState(t){if(t)if(console.log("尝试恢复视频状态:",t,"用户关闭标记:",this.userClosedVideo),this.userClosedVideo)console.log("用户已主动关闭视频，不恢复视频状态");else if(t.visible!==this.videoVisible&&(this.videoVisible=t.visible),this.videoVisible&&this.videoUrl&&(this.videoContext=e.index.createVideoContext("myVideo",this),this.videoContext))try{t.position>0&&this.videoContext.seek(t.position),t.isPlaying?(this.videoContext.play(),this.isVideoPlaying=!0):(this.videoContext.pause(),this.isVideoPlaying=!1),console.log("视频状态恢复成功")}catch(i){console.error("恢复视频状态时出错:",i)}},async handleDelete(t){try{e.index.showModal({title:"确认删除",content:"确定要删除这篇文章吗？",success:async i=>{if(i.confirm){e.index.showLoading({title:"删除中...",mask:!0});const i=e.nr.importObject("articleWx",{customUI:!0}),o=await i.del(t,this.userStore.userInfo.uid);if(console.log("删除返回结果:",o),!o||!o.deleted)throw new Error("删除失败，请重试");{const i=this.userArticleData.findIndex((e=>e._id===t));-1!==i&&this.userArticleData.splice(i,1),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"success",duration:1500})}}}})}catch(i){console.error("删除出错:",i),e.index.hideLoading(),e.index.showToast({title:i.message||"删除失败，请重试",icon:"none",duration:2e3})}},previewImage(t,i){e.index.previewImage({urls:t,current:i})},handleContact(){return this.userStore.userInfo.isLogin?this.userArticleInfo&&"未填写"!==this.userArticleInfo.mobile?void e.index.makePhoneCall({phoneNumber:this.userArticleInfo.mobile}):e.index.showToast({icon:"none",title:"他并不想让人联系"}):i.testLogin()},scrolltolower(){if(console.log("触底加载被触发，状态:",{isLoading:this.isLoading,hasMore:this.hasMore,isScrollLoading:this.isScrollLoading}),this.isLoading||!this.hasMore||this.isScrollLoading)return void console.log("跳过加载: "+(this.isLoading?"正在加载中":this.isScrollLoading?"防抖期间":"没有更多数据"));this.isScrollLoading=!0,this.status="loading",this.scrollToLowerTimer&&clearTimeout(this.scrollToLowerTimer);let e=null;if(this.videoVisible&&this.videoContext){e={isPlaying:this.isVideoPlaying,position:0,visible:this.videoVisible};try{this.videoContext.pause(),e.position=this.videoContext.currentTime||0,e.isPlaying&&this.videoContext.play()}catch(t){console.error("保存视频状态时出错:",t)}}this.scrollToLowerTimer=setTimeout((()=>{console.log("开始加载更多数据 (防抖后)，保存的视频状态:",e),this.loadMoreData(e)}),500)},updateLocalViewCount(e){if(!e||!e.articleId)return void console.log("更新浏览量失败：无效的文章数据");const t=this.userArticleData.find((t=>t._id===e.articleId));t?(void 0!==e.viewCount?t.look_count=e.viewCount:void 0!==t.look_count?t.look_count++:t.look_count=1,console.log(`文章(${e.articleId})浏览量已更新: ${t.look_count}`)):console.log(`未找到文章: ${e.articleId}`)},previewLatestImages(t){this.latestArticleImages&&this.latestArticleImages.length>0&&e.index.previewImage({current:this.latestArticleImages[t],urls:this.latestArticleImages})},getArticleImages(e){const t=[];return e?(e.images&&e.images.length>0&&e.images.forEach((e=>{e.thumbnailURL?t.push(this.processImageUrl(e.thumbnailURL)):e.compressedURL?t.push(this.processImageUrl(e.compressedURL)):e.url?t.push(this.processImageUrl(e.url)):"string"==typeof e&&t.push(this.processImageUrl(e))})),e.imgArr&&e.imgArr.length>0&&e.imgArr.forEach((e=>{t.push(this.processImageUrl(e))})),e.coverImage&&0===t.length&&t.push(this.processImageUrl(e.coverImage)),t):t},previewArticleImage(t,i){const o=this.getArticleImages(t);o&&o.length>0&&e.index.previewImage({current:o[i],urls:o})},onRefresh(){this.isRefreshing=!0,this.refreshStartTime=Date.now(),this.getArticelList(!0).then((()=>{const t=Date.now()-this.refreshStartTime;t<800?setTimeout((()=>{this.isRefreshing=!1,e.index.showToast({title:"刷新成功",icon:"success",duration:1500})}),800-t):(this.isRefreshing=!1,e.index.showToast({title:"刷新成功",icon:"success",duration:1500}))})).catch((()=>{const t=Date.now()-this.refreshStartTime;t<800?setTimeout((()=>{this.isRefreshing=!1,e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}),800-t):(this.isRefreshing=!1,e.index.showToast({title:"刷新失败",icon:"none",duration:1500}))}))},hideShareGuide(){this.showShareArrow=!1},initVideoContext(){this.videoVisible&&this.videoUrl?(console.log("初始化视频上下文"),this.videoContext=e.index.createVideoContext("myVideo",this)):console.log("视频组件不可见或没有视频URL，跳过初始化")},onVideoPlay(){console.log("视频开始播放"),this.isVideoPlaying=!0},onVideoPause(){console.log("视频暂停播放"),this.isVideoPlaying=!1},onVideoEnded(){console.log("视频播放结束"),this.isVideoPlaying=!1},onVideoError(e){console.error("视频播放错误:",e);this.findNextVideo()||this.hideVideo()},findNextVideo(){if(console.log("查找下一个可用视频"),this.videoUrlCache&&this.videoUrlCache.length>0&&(this.videoUrlCache=this.videoUrlCache.filter((e=>e!==this.videoUrl)),this.videoUrlCache.length>0))return console.log("从缓存中找到其他视频:",this.videoUrlCache[0]),this.videoUrl=this.videoUrlCache[0],this.videoVisible=!0,this.$nextTick((()=>{this.initVideoContext()})),!0;if(!this.userArticleData||0===this.userArticleData.length)return console.log("没有文章数据，无法查找视频"),!1;const t=[];for(let e of this.userArticleData){const i=this.extractVideoUrlFromArticle(e);i&&i!==this.videoUrl&&t.push(i)}return t.length>0?(console.log("找到其他视频:",t[0]),this.videoUrlCache=t,this.videoUrl=t[0],this.videoVisible=!0,this.$nextTick((()=>{this.initVideoContext()})),!0):(console.log("没有找到其他可用视频"),e.index.showToast({title:"未找到其他视频",icon:"none"}),!1)},handleFullscreenChange(e){console.log("全屏状态变化:",e.detail.fullScreen)},hideVideo(){console.log("隐藏视频组件被调用"),this.userClosedVideo=!0,this.videoContext&&this.videoContext.pause(),this.videoVisible=!1,this.videoUrl=""},showVideo(){this.userClosedVideo=!1,this.videoVisible=!0,this.$nextTick((()=>{this.initVideoContext()}))},extractVideoFromArticles(){if(console.log("尝试从文章中提取视频链接"),this.userClosedVideo)return console.log("用户已主动关闭视频，跳过视频提取"),!1;if(!this.userArticleData||0===this.userArticleData.length)return console.log("没有文章数据，无法提取视频"),!1;const e=this.userArticleData.map(((e,t)=>({index:t,time:e.create_time||e.createTime||e.time||0,priority:this.getVideoPriority(e)}))).sort(((e,t)=>e.priority!==t.priority?t.priority-e.priority:"string"==typeof e.time&&"string"==typeof t.time?new Date(t.time)-new Date(e.time):"number"==typeof e.time&&"number"==typeof t.time?t.time-e.time:e.index-t.index)).map((e=>e.index));console.log("排序后的文章索引:",e);const t=[];let i=null;for(let o=0;o<e.length;o++){const s=e[o],r=this.userArticleData[s];console.log(`检查文章索引 ${s} 是否包含视频`);const l=this.extractVideoUrlFromArticle(r);l&&(i||(i=l),t.includes(l)||t.push(l))}return i?(console.log("找到视频链接:",i),this.videoUrlCache=t,this.videoUrl=i,this.videoVisible=!0,this.$nextTick((()=>{this.initVideoContext()})),!0):(console.log("未在文章中找到有效的视频链接"),!1)},getVideoPriority(e){let t=0;return(e.videoURL||e.videoUrl||e.video_url)&&(t+=10),e.videos&&Array.isArray(e.videos)&&e.videos.length>0&&(t+=8),e.content&&e.content.length>500&&(t+=3),(e.like_count>5||e.look_count>20)&&(t+=5),t},extractVideoUrlFromArticle(e){if(!e)return null;if(e.videoURL&&"string"==typeof e.videoURL&&this.isValidVideoUrl(e.videoURL))return console.log("找到videoURL字段中的视频链接:",e.videoURL),e.videoURL;const t=["videoUrl","video_url","video","videoSrc","video_src","url"];for(let o of t)if(e[o]&&"string"==typeof e[o]&&this.isValidVideoUrl(e[o]))return console.log(`找到视频链接(${o}):`,e[o]),e[o];const i=["videos","videoArr","video_arr","videoList","video_list"];for(let o of i)if(e[o]&&Array.isArray(e[o])&&e[o].length>0){const t=e[o][0];if(console.log(`找到视频数组(${o}):`,t),"string"==typeof t&&this.isValidVideoUrl(t))return t;if("object"==typeof t){const e=["url","src","source","path","videoUrl"];for(let i of e)if(t[i]&&"string"==typeof t[i]&&this.isValidVideoUrl(t[i]))return t[i]}}if(e.content){const t=this.extractVideoUrlFromContent(e.content);if(t)return console.log("从内容中提取到视频链接:",t),t}return null},extractVideoUrlFromContent(e){if(!e||"string"!=typeof e)return null;const t=[/cloud:\/\/[^"'\s<>]+\.(mp4|mov|m3u8)/gi,/cloud-file:\/\/[^"'\s<>]+\.(mp4|mov|m3u8)/gi,/https?:\/\/[^\s<>"']+\.(mp4|avi|mov|wmv|flv|mkv|webm|m3u8|3gp|rm|rmvb)/gi,/https?:\/\/v\.qq\.com\/[^\s<>"']+/gi,/https?:\/\/www\.youtube\.com\/watch\?v=[^\s<>"']+/gi,/https?:\/\/youtu\.be\/[^\s<>"']+/gi,/https?:\/\/vimeo\.com\/[^\s<>"']+/gi,/https?:\/\/www\.bilibili\.com\/video\/[^\s<>"']+/gi,/https?:\/\/www\.ixigua\.com\/[^\s<>"']+/gi,/https?:\/\/www\.kuaishou\.com\/[^\s<>"']+/gi,/https?:\/\/[^\s<>"']+\.bspapp\.com\/[^\s<>"']+/gi,/https?:\/\/[^\s<>"']+\.cdn[^\s<>"']*\/[^\s<>"']+/gi,/https?:\/\/mp\.weixin\.qq\.com\/[^\s<>"']*video[^\s<>"']+/gi,/https?:\/\/wxsnsdy\.wxs\.qq\.com\/[^\s<>"']+/gi,/<video[^>]*src=["']([^"']+)["'][^>]*>/gi,/<video[^>]*>[\s\S]*?<source[^>]*src=["']([^"']+)["'][^>]*>/gi],i=[/<video[^>]*src=["']([^"']+)["'][^>]*>/i,/<video[^>]*>[\s\S]*?<source[^>]*src=["']([^"']+)["'][^>]*>/i];for(let s of i){const t=e.match(s);if(t&&t[1]){const e=t[1];if(this.isValidVideoUrl(e))return e}}for(let s of t){const t=e.match(s);if(t&&t.length>0)for(const e of t)if(this.isValidVideoUrl(e))return e}try{const t=e.match(/"(https?:\/\/[^"]+\.(mp4|mov|m3u8))"/gi);if(t&&t.length>0)for(let e of t){const t=e.replace(/^"|"$/g,"");if(this.isValidVideoUrl(t))return t}}catch(o){console.error("JSON解析错误:",o)}return null},isValidVideoUrl(e){if(!e||"string"!=typeof e)return!1;if(e.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp)($|\?)/i))return!1;const t=[".mp4",".avi",".mov",".wmv",".flv",".mkv",".webm",".m3u8",".3gp",".rm",".rmvb"],i=t.some((t=>e.toLowerCase().includes(t))),o=["youku","youtube","vimeo","bilibili","qq.com/video","weixin.qq","douyin","bspapp.com","ixigua.com","kuaishou.com","cdn","mp4",".video."].some((t=>e.toLowerCase().includes(t))),s=e.startsWith("cloud://")&&t.some((t=>e.toLowerCase().endsWith(t))),r=e.includes(".m3u8")||e.includes(".mpd");return i||o||s||r},shareToTimeline(){console.log("点击分享到朋友圈按钮，显示全屏弹窗"),this.showFullScreenPopup=!0},closeFullScreenPopup(){this.showFullScreenPopup=!1},goToPublish(){if(!this.userStore.userInfo.isLogin)return i.testLogin();e.index.showLoading({title:"正在跳转...",mask:!0}),setTimeout((()=>{e.index.navigateTo({url:"/pages/fabu/fabu",success:()=>{console.log("跳转到发布页面成功"),e.index.hideLoading()},fail:t=>{console.error("发布页面跳转失败:",t),e.index.hideLoading(),e.index.redirectTo({url:"/pages/fabu/fabu",success:()=>{console.log("使用redirectTo跳转成功")},fail:t=>{console.error("redirectTo也失败了:",t),e.index.reLaunch({url:"/pages/fabu/fabu",fail:t=>{console.error("所有导航方法都失败了:",t),e.index.showToast({title:"页面跳转失败，请重试",icon:"none",duration:2e3})}})}})}})}),100)},processImageUrl(e){if(!e)return"";if(e.startsWith("/static/")||e.startsWith("wxfile://")||e.startsWith("http://tmp/"))return e;try{if(e.includes("watermark")||e.includes("imageMogr2")){const t=e.split("?")[0];if(t)return t}return e}catch(t){return console.error("处理图片URL出错:",t),""}},extractLatestArticleImages(){if(console.log("提取最新文章图片"),!this.userArticleData||0===this.userArticleData.length)return console.log("没有文章数据，无法提取图片"),this.latestArticleImages=[],[];const e=this.userArticleData.map(((e,t)=>({index:t,time:e.create_time||e.createTime||e.time||0}))).sort(((e,t)=>"string"==typeof e.time&&"string"==typeof t.time?new Date(t.time)-new Date(e.time):"number"==typeof e.time&&"number"==typeof t.time?t.time-e.time:e.index-t.index)).map((e=>e.index)),t=[];for(let i=0;i<e.length&&t.length<5;i++){const o=e[i],s=this.userArticleData[o],r=this.getArticleImages(s);if(r&&r.length>0)for(let e of r)!t.includes(e)&&t.length<5&&t.push(e)}return this.latestArticleImages=t,console.log("提取到的最新文章图片:",this.latestArticleImages),this.latestArticleImages},checkArticleHasVideo(e){if(!e)return!1;if(e.videoURL&&"string"==typeof e.videoURL&&this.isValidVideoUrl(e.videoURL))return!0;const t=["videoUrl","video_url","video","videoSrc","video_src","url"];for(let o of t)if(e[o]&&"string"==typeof e[o]&&this.isValidVideoUrl(e[o]))return!0;const i=["videos","videoArr","video_arr","videoList","video_list"];for(let o of i)if(e[o]&&Array.isArray(e[o])&&e[o].length>0){const t=e[o][0];if("string"==typeof t&&this.isValidVideoUrl(t))return!0;if("object"==typeof t){const e=["url","src","source","path","videoUrl"];for(let i of e)if(t[i]&&"string"==typeof t[i]&&this.isValidVideoUrl(t[i]))return!0}}if(e.content){if(this.extractVideoUrlFromContent(e.content))return!0}return!1},playArticleVideo(t){if(!t)return;const i=this.extractVideoUrlFromArticle(t);i?(this.videoUrl=i,this.videoVisible=!0,this.userClosedVideo=!1,this.$nextTick((()=>{this.initVideoContext()})),console.log("正在播放文章视频:",i)):e.index.showToast({title:"无法提取视频链接",icon:"none"})},async searchAllVideosOnLoad(){console.log("正在搜索所有文章的视频...");let t=[];if(this.userArticleData&&this.userArticleData.length>0){console.log(`从${this.userArticleData.length}篇已加载文章中搜索视频...`);for(let e of this.userArticleData){const i=this.extractVideoUrlFromArticle(e);i&&this.isValidVideoUrl(i)&&(console.log(`在文章(${e._id||"未知ID"})中找到视频: ${i}`),t.includes(i)||t.push(i))}}const i=this.totalArticleCount||0,o=this.userArticleData?this.userArticleData.length:0;if(t.length>0||o>=i)console.log(`已找到${t.length}个视频，不需要加载更多文章`);else if(i>o&&this.hasMore){console.log(`已加载${o}篇文章，共有${i}篇，尝试加载更多来搜索视频...`);try{this.pageNo;const e=3;for(let i=0;i<e&&this.hasMore&&0===t.length;i++)if(this.pageNo++,console.log(`加载第${this.pageNo}页文章来搜索视频...`),await this.getArticelList(!1),this.userArticleData&&this.userArticleData.length>o){const e=this.userArticleData.slice(o);console.log(`从新加载的${e.length}篇文章中搜索视频...`);for(let i of e){const e=this.extractVideoUrlFromArticle(i);if(e&&this.isValidVideoUrl(e)&&(console.log(`在新加载文章(${i._id||"未知ID"})中找到视频: ${e}`),t.includes(e)||t.push(e),t.length>=5))break}}}catch(s){console.error("加载更多文章搜索视频时出错:",s)}}return t.length>0?(console.log(`共找到${t.length}个视频链接:`,t),this.videoUrlCache=t,this.userClosedVideo||(this.videoUrl=t[0],this.videoVisible=!0,this.$nextTick((()=>{this.initVideoContext()}))),e.index.$emit("videosFound",{count:t.length,videos:t}),t):(console.log("未找到任何视频链接"),[])}},onShareAppMessage(){return this.getShareInfo()},onShareTimeline(){return this.getTimelineShareInfo()}};if(!Array){(e.resolveComponent("user-header")+e.resolveComponent("articleItem")+e.resolveComponent("uni-load-more"))()}Math||((()=>"../../components/user-header/user-header.js")+(()=>"../../components/articleItem/articleItem.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js"))();const s=e._export_sfc(o,[["render",function(t,i,o,s,r,l){return e.e({a:e.o(l.handleContact),b:e.o(l.goToPublish),c:e.p({articleTotal:l.articleTotal,userInfo:r.userArticleInfo}),d:r.videoUrl&&r.videoUrl.length>0},r.videoUrl&&r.videoUrl.length>0?{e:r.videoUrl,f:e.o(((...e)=>l.onVideoPlay&&l.onVideoPlay(...e))),g:e.o(((...e)=>l.onVideoPause&&l.onVideoPause(...e))),h:e.o(((...e)=>l.onVideoEnded&&l.onVideoEnded(...e))),i:e.o(((...e)=>l.onVideoError&&l.onVideoError(...e))),j:e.o(((...e)=>l.handleFullscreenChange&&l.handleFullscreenChange(...e))),k:e.o(((...e)=>l.hideVideo&&l.hideVideo(...e)))}:{},{l:r.userArticleData&&r.userArticleData.length>0},r.userArticleData&&r.userArticleData.length>0?{m:e.f(r.userArticleData,((t,i,o)=>e.e({a:t.hasVideo},t.hasVideo?{b:e.o((e=>l.playArticleVideo(t)),t._id)}:{},{c:e.o(((e,t)=>l.previewImage(t,e)),t._id),d:e.o(l.handleContact,t._id),e:e.o(l.handleDelete,t._id),f:t._id,g:"d775b36a-1-"+o,h:e.p({item:t,avatarClickEnabled:r.avatarClickEnabled})})))}:{},{n:e.p({color:"#d6d6d6",status:r.status,"content-text":r.loadMoreText}),o:e.o(((...e)=>l.scrolltolower&&l.scrolltolower(...e))),p:r.isRefreshing,q:e.o(((...e)=>l.onRefresh&&l.onRefresh(...e))),r:e.o(((...e)=>l.shareToTimeline&&l.shareToTimeline(...e))),s:r.showFullScreenPopup},r.showFullScreenPopup?{t:e.o(((...e)=>l.closeFullScreenPopup&&l.closeFullScreenPopup(...e))),v:r.dynamicShareImage||r.defaultShareImage,w:e.o(((...e)=>l.closeFullScreenPopup&&l.closeFullScreenPopup(...e))),x:e.o((()=>{})),y:e.o(((...e)=>l.closeFullScreenPopup&&l.closeFullScreenPopup(...e)))}:{},{z:e.gei(t,"")})}],["__scopeId","data-v-d775b36a"]]);o.__runtimeHooks=6,wx.createPage(s);
