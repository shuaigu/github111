"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/isLogin.js"),n=require("../../store/user.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("articleItem")+e.resolveComponent("uni-load-more"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/articleItem/articleItem.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js"))();const t={__name:"index",setup(t){const i={isLoading:!1,showLoading(e="加载中...",o=!0){this.isLoading=!0},hideLoading(){this.isLoading=!1}},a=e.ref(!0),l=n.useUserInfoStore();e.ref(null);const c=e.ref([]),s=e.ref(0),r=e.ref(""),u=e.nr.importObject("cateWx",{customUI:!0}),d=e.nr.importObject("articleWx",{customUI:!0});e.nr.importObject("fabuWx",{customUI:!0});const g=e.ref(null),v=e.ref(1),h=e.ref([]);let f="";const m=e.ref(!0),w=async o=>{if(!i.isLoading)try{f=o||"",console.log(f,"临时id"),i.showLoading("加载文章列表...",!0),m.value=!0;const e=await d.getArticle(o||"",v.value,8);console.log(e),h.value=e.data}catch(n){console.log(n),e.index.showToast({title:"加载失败，请重试",icon:"none",duration:2e3})}finally{i.hideLoading(),m.value=!1}};e.onPullDownRefresh((async()=>{if(i.isLoading)e.index.stopPullDownRefresh();else{v.value=1,p.value="more";try{await w(f)}catch(o){console.error("下拉刷新失败:",o),e.index.showToast({title:"刷新失败，请重试",icon:"none"})}finally{e.index.stopPullDownRefresh()}}}));const p=e.ref("more");e.onReachBottom((async()=>{if(console.log("触底"),"noMore"!==p.value&&!i.isLoading){p.value="loading";try{i.showLoading("加载更多...",!1),v.value++;const e=await d.getArticle(f,v.value,8);h.value=[...h.value,...e.data],e.data.length>0?p.value="more":p.value="noMore"}catch(o){console.error("加载更多失败:",o),e.index.showToast({title:"加载失败，请重试",icon:"none"}),p.value="more"}finally{i.hideLoading()}}}));const x=async o=>{try{e.index.showModal({title:"确认删除",content:"确定要删除这篇文章吗？",success:async n=>{if(n.confirm){if(i.showLoading("删除中..."),console.log("正在删除文章ID:",o,"用户ID:",l.userInfo.uid),!l.userInfo.uid)return e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void i.hideLoading();const n=await d.del(o,l.userInfo.uid);if(console.log("删除接口返回结果:",n),!n||!n.deleted)throw new Error(n.message||"删除失败，请重试");{const n=h.value.findIndex((e=>e._id===o));-1!==n&&h.value.splice(n,1),i.hideLoading(),e.index.showToast({title:"删除成功",icon:"success",duration:2e3})}}}})}catch(n){console.error("删除文章失败:",n),i.hideLoading(),e.index.showToast({title:n.message||"删除失败，请重试",icon:"none",duration:2e3})}},_=n=>(console.log(n),l.userInfo.isLogin?"未填写"===n?e.index.showToast({icon:"none",title:"他并不想让人联系"}):void e.index.makePhoneCall({phoneNumber:n}):o.testLogin()),y=o=>{if(!a.value)return console.log("头像点击功能已禁用"),void e.index.showToast({title:"联系管理员",icon:"none",duration:2e3});e.index.navigateTo({url:`/pages/userArticleList/userArticleList?userId=${o}`})};e.onMounted((()=>{(async()=>{try{let o=await e.index.getLocation({type:"gcj02"}).catch((e=>(console.error("获取位置失败:",e),{longitude:116.397428,latitude:39.90923})));const n=await u.get(null,!1);if(!n||!n.data)throw new Error("获取分类失败，返回数据格式错误");const t=await d.addReady(`${o.longitude},${o.latitude}`);g.value={address:t.address||"未知地址",district:t.district||"未知区域",longitude:o.longitude,latitude:o.latitude};let i=n.data.map((e=>{const o=e.cate_name&&t.district&&(e.cate_name.includes(t.district)||t.district.includes(e.cate_name));return{...e,cate_img:I(e),isLocationCategory:o,district:o?t.district:""}}));i.sort(((e,o)=>e.isLocationCategory&&!o.isLocationCategory?-1:!e.isLocationCategory&&o.isLocationCategory?1:0)),c.value=i,console.log("分类列表加载成功:",c.value),i.length>0&&(r.value=i[0]._id,s.value=0),v.value=1,w(r.value)}catch(o){console.error("获取分类失败:",o),e.index.showToast({title:"获取分类失败，请重试",icon:"none",duration:2e3}),w()}finally{e.index.hideLoading()}})(),e.index.$on("articlePublished",(o=>{console.log("收到文章发布成功事件，文章ID:",o),v.value=1,p.value="more",w(f),e.index.showToast({title:"发布成功，内容已更新",icon:"success",duration:2e3})})),e.index.$on("refreshIndexOnce",(e=>{console.log("收到一次性刷新事件，文章ID:",e),v.value=1,p.value="more",setTimeout((()=>{w(f).then((()=>{if(e&&h.value.length>0){const o=h.value.findIndex((o=>o._id===e));-1!==o&&console.log("找到新发布的文章，位置:",o)}})).catch((e=>{console.error("刷新文章列表失败:",e)}))}),300)})),e.index.$on("viewCountUpdated",(e=>{C(e)})),e.index.$on("articleViewCountUpdated",(e=>{console.log("收到文章浏览量更新事件:",e),e&&e.articleId&&C(e)})),e.index.showShareMenu({withShareTicket:!0}),e.index.$on("avatarClickChanged",(e=>{console.log("首页收到头像点击状态变化事件:",e),a.value=e}))})),e.onUnmounted((()=>{e.index.$off("articlePublished"),e.index.$off("refreshIndexOnce"),e.index.$off("viewCountUpdated"),e.index.$off("articleViewCountUpdated"),e.index.$off("avatarClickChanged")})),e.onPageScroll((()=>{i.hideLoading()}));let L=0;e.onBackPress((e=>{console.log("检测到返回按钮事件",e);const o=Date.now();if(o-L<1e3)return console.log("距离上次刷新时间不足1秒，跳过刷新"),!1;L=o;const n=getCurrentPages(),t=n[n.length-1];return t&&"pages/index/index"===t.route&&(console.log("当前在首页，检查是否需要刷新"),setTimeout((()=>{v.value=1,p.value="more",w(f)}),300)),!1})),e.onActivated((()=>{console.log("首页被激活");const e=Date.now();e-L>5e3&&(console.log("页面激活，自动刷新内容"),L=e,v.value=1,p.value="more",w(f))}));const I=e=>e&&e.cate_img?e.cate_img:"/static/images/defalut.png",C=e=>{if(!e||!e.articleId||!h.value.length)return void console.log("更新浏览量失败：无效的文章数据或文章列表为空");const o=h.value.findIndex((o=>o._id===e.articleId));-1!==o?(void 0!==e.viewCount?(h.value[o].look_count=e.viewCount,void 0!==h.value[o].view_count&&(h.value[o].view_count=e.viewCount)):(void 0!==h.value[o].look_count?h.value[o].look_count++:h.value[o].look_count=1,void 0!==h.value[o].view_count&&(h.value[o].view_count=h.value[o].look_count)),console.log(`文章[${e.articleId}]浏览量已更新为: ${h.value[o].look_count}`)):console.log(`未找到文章: ${e.articleId}`)};return e.onShow((()=>{(async()=>{try{console.log("首页正在获取按钮状态...");const o=e.nr.importObject("sendOn",{customUI:!0}),n=await o.get();if(n&&n.data&&n.data.length>0){const e=void 0===n.data[0].avatarClick||n.data[0].avatarClick;a.value=e,console.log("首页头像点击状态:",a.value)}else console.error("获取按钮状态失败: 数据格式不正确")}catch(o){console.error("获取按钮状态失败:",o)}})()})),(o,n)=>e.e({a:e.f(c.value,((o,n,t)=>e.e({a:o.cate_img},o.cate_img?{b:o.cate_img}:{},{c:e.t(o.cate_name),d:o.isLocationCategory},(o.isLocationCategory,{}),{e:o._id,f:r.value===o._id?1:"",g:o.isLocationCategory?1:"",h:e.o((e=>((e,o)=>{s.value=e,v.value=1,p.value="more",r.value=o,w(o)})(n,o._id)),o._id)}))),b:0==c.value.length},0==c.value.length?{c:e.p({type:"spinner-cycle",size:"24",color:"#399bfe"})}:{},{d:0===h.value.length&&m.value},0===h.value.length&&m.value?{e:e.p({type:"spinner-cycle",size:"48",color:"#399bfe"})}:{},{f:0===h.value.length&&!m.value},0!==h.value.length||m.value?{}:{g:e.p({color:"#5cb85c","custom-prefix":"icon",type:"lishuai-a-00jichuiconkongzhuangtaiwuneirong",size:"58"})},{h:e.f(h.value,((o,n,t)=>({a:o._id,b:e.o(_,o._id),c:e.o(((o,n)=>((o,n)=>{if(!o||!o.length)return void console.error("预览图片缺少URLs参数");let t=o;"object"==typeof n&&null!==n&&(n=n.compressedURL),o.length>0&&"object"==typeof o[0]&&(t=o.map((e=>e.compressedURL))),e.index.previewImage({urls:t,current:n||t[0],indicator:"number",loop:!0,success:()=>{console.log("图片预览成功")},fail:o=>{console.error("预览图片失败:",o),e.index.showToast({title:"预览图片失败",icon:"none"})},complete:()=>{}})})(n,o)),o._id),d:e.o(y,o._id),e:e.o(x,o._id),f:"55ac72c1-3-"+t,g:e.p({item:o,avatarClickEnabled:a.value})}))),i:0==!h.value.length},0==!h.value.length?{j:e.p({color:"#cccccc",iconType:"auto",status:p.value})}:{},{k:e.gei(o,"")})}},i=e._export_sfc(t,[["__scopeId","data-v-55ac72c1"]]);t.__runtimeHooks=1,wx.createPage(i);
