"use strict";const e=require("../../common/vendor.js"),t=require("../../store/user.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const a={name:"Fabu"},i=Object.assign(a,{setup(a){const i=t.useUserInfoStore(),o=e.nr.importObject("articleWx",{customUI:!0}),l=e.nr.importObject("fabuWx",{customUI:!0});e.ref(null);const n=e.ref([]),s=e.ref(0),c=e.ref([]);e.ref(0);const r=e.ref(null),u=e.ref(""),d=e.ref(null),g=e.ref(null),v=e.ref(!1);e.ref(null);const m=e.ref(0),h=e.ref(""),f=e.ref(170),p=e.ref(0),w=e.ref(0);e.ref(null);const y=e.ref(!1),_=e.ref(!1),x=e.ref(""),b=e.ref(0);e.computed((()=>w.value-p.value));const L=e.ref(!1),T=e.ref(0),R=e.ref(0),U=e.ref(100),k=e.ref("");let F=null;e.ref(["欢迎咨询","全新产品","限时优惠","诚信交易","支持自提"]);const I=e.ref(!1),$=e.ref([{name:"常用",emojis:["😊","👍","❤️","👋","🙏","🔥","💯","👏","🎉","✨","🌹","💪","🤝"]},{name:"表情",emojis:["😀","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","😉","😌","😍"]},{name:"手势",emojis:["👍","👎","👌","✌️","🤞","🤟","🤙","🤛","🤜","👊","✊","🤝","👏"]}]),C=e.ref(0),P=async()=>{try{e.index.showLoading({title:"加载中...",mask:!1});let c=await e.index.getLocation({type:"gcj02"}).catch((e=>(console.error("获取位置失败:",e),{longitude:116.397428,latitude:39.90923})));const u=await o.addReady(`${c.longitude},${c.latitude}`);if(console.log("获取分类和地址信息成功:",u),r.value={address:u.address||"未知地址",district:u.district||"未知区域"},u.district&&"未知区域"!==u.district)try{const e=await l.processCategoryFromDistrict(u.district);if(console.log("区域分类处理结果:",e),0===e.code&&e.data){const e=await o.addReady(`${c.longitude},${c.latitude}`);e.cateList&&e.cateList.length>0&&(u.cateList=e.cateList)}}catch(t){console.error("处理区域分类失败:",t)}if(u.cateList&&u.cateList.length>0){const e=u.cateList.filter((e=>e.is_location_based&&e.location_district===u.district));if(e.length>0){n.value=e.map((e=>({...e,icon:e.cate_img||j(e.cate_name)}))),d.value=n.value[0]._id,s.value=0;const t=n.value[0];if(!t.cate_img||t.cate_img.includes("default"))try{console.log("为位置分类自动生成图标:",t.cate_name);const e=await generateCategoryIcon(t.cate_name,t._id);e&&e.iconURL&&(t.icon=e.iconURL,n.value[0].icon=e.iconURL,n.value[0].cate_img=e.iconURL)}catch(a){console.error("自动生成位置分类图标失败:",a)}}else try{if(u.district&&"未知区域"!==u.district){const e=await l.createLocationCategory({district:u.district,address:u.address});if(e&&e.categoryId){const t={_id:e.categoryId,cate_name:u.district,is_location_based:!0,location_district:u.district,icon:j(u.district)};n.value=[t],d.value=t._id,s.value=0,W(t)}else S()}else S()}catch(i){console.error("创建位置分类失败:",i),S()}}else console.warn("未获取到分类列表或分类列表为空"),S()}catch(c){console.error("获取位置和分类失败:",c),e.index.showToast({title:"获取分类失败，请重试",icon:"none",duration:2e3}),r.value={address:"未知地址",district:"未知区域"},S()}finally{e.index.hideLoading()}},S=()=>{n.value=[{_id:"default",cate_name:"默认分类",icon:"/static/images/category/default.png"}],d.value="default",s.value=0},j=e=>({"宠物用品":"/static/images/category/pet.png","水杯餐具":"/static/images/category/tableware.png","日用百货":"/static/images/category/daily.png","清洁工具":"/static/images/category/cleaning.png","收纳整理":"/static/images/category/storage.png","文具教具":"/static/images/category/stationery.png","畜牧农资":"/static/images/category/agriculture.png","纸品湿巾":"/static/images/category/tissue.png","个人护理":"/static/images/category/personal.png","厨房烹饪":"/static/images/category/kitchen.png","节庆礼品":"/static/images/category/gift.png","图书乐器":"/static/images/category/book.png","家庭清洁":"/static/images/category/home.png","花卉园艺":"/static/images/category/garden.png","锅具水壶":"/static/images/category/pot.png"}[e]||"/static/images/default.png"),M=async()=>{try{const t=(await e.index.chooseImage({count:9,sizeType:["original"],sourceType:["album","camera"],mediaType:["image"]})).tempFilePaths.map((async(t,a)=>{const o=c.value.length;c.value.push({fileURL:"",thumbnailURL:t,progress:0});try{const a=await e.index.getImageInfo({src:t}).catch((e=>(console.error("获取图片尺寸信息失败:",e),{width:0,height:0}))),n=await l.getUploadFileOptions({cloudPath:`images/${i.userInfo.uid}/${Date.now()}-${o}.jpg`,fileType:"image",isOriginal:!0,userNickName:i.userInfo.nickName,imageWidth:a.width,imageHeight:a.height});let s=null,r=!0;return s=setTimeout((function e(){var t;if(!r)return;const a=(null==(t=c.value[o])?void 0:t.progress)||0;if(a>=98)return void(r=!1);let i;i=a<30?a+5:a<70?a+3:a<90?a+1:a+.5,c.value[o].progress=Math.min(98,i),s=setTimeout(e,800)}),500),new Promise(((a,i)=>{const l=e.index.uploadFile({...n.uploadFileOptions,filePath:t,success:()=>{r=!1,clearTimeout(s),c.value[o].progress=100,c.value[o].fileURL=n.fileURL,c.value[o].compressedURL=n.compressedURL,c.value[o].thumbnailURL=n.thumbnailURL,a(!0)},fail:e=>{r=!1,clearTimeout(s),console.error("上传失败",e),c.value.splice(o,1),i(e)}});try{l.onProgressUpdate((e=>{if(e&&"number"==typeof e.progress){r=!1,clearTimeout(s);const t=Math.min(99,e.progress);c.value[o].progress=t}}))}catch(u){console.log("进度更新回调不可用，使用备用进度显示",u)}}))}catch(n){return c.value.splice(o,1),console.error("上传图片错误:",n),Promise.reject(n)}}));await Promise.all(t)}catch(t){e.index.showToast({title:"上传失败",icon:"none"}),console.error("图片上传过程错误:",t)}},A=t=>{const a=h.value.trim();if(!a)return void(g.value=null);/^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?$/.test(a)&&(g.value=a,e.index.vibrateShort&&e.index.vibrateShort({type:"light"}))},D=()=>{g.value=null},z=e.ref(!1),O=e.ref("");e.onLoad((t=>{console.log("页面加载参数:",t),"edit"===t.mode&&t.article_id?(z.value=!0,O.value=t.article_id,P().then((()=>{E()})).catch((t=>{console.error("获取分类失败:",t),e.index.showToast({title:"获取分类失败",icon:"none"})}))):P().catch((t=>{console.error("获取分类失败:",t),e.index.showToast({title:"获取分类失败",icon:"none"})}))}));const E=async()=>{try{e.index.showLoading({title:"加载中...",mask:!0});const t=await o.getArticleDetal(O.value);if(!(t&&t.articleRes&&t.articleRes.data&&t.articleRes.data[0]))throw new Error("获取文章数据失败");const a=t.articleRes.data[0];if(u.value=a.content||"",a.cate_id){d.value=a.cate_id;const e=n.value.findIndex((e=>e._id===a.cate_id));-1!==e&&(s.value=e)}a.images&&a.images.length>0&&(c.value=a.images.map((e=>({fileURL:e.url||e,thumbnailURL:e.thumbnailURL||e.compressedURL||e.url||e,compressedURL:e.compressedURL||e.url||e,progress:100})))),a.videoURL&&(g.value=a.videoURL),r.value={address:a.address||"未知地址",district:a.district||"未知区域"}}catch(t){console.error("加载文章数据失败:",t),e.index.showToast({title:"加载文章数据失败",icon:"none"})}finally{e.index.hideLoading()}},N=async()=>{if(u.value.trim()){if(!d.value)return e.index.showToast({title:"请选择分类",icon:"none"}),void(n.value.length&&"default"!==n.value[0]._id||e.index.showModal({title:"提示",content:"未能获取到分类信息，是否重新获取？",success:e=>{e.confirm&&q()}}));if(r.value&&r.value.address){e.index.showLoading({title:z.value?"更新中...":"发布中...",mask:!1});try{const t=c.value.filter((e=>e.fileURL&&100===e.progress)).map((e=>({url:e.fileURL,compressedURL:e.compressedURL,thumbnailURL:e.thumbnailURL}))),a=g.value||null,l=n.value.find((e=>e._id===d.value))||null,s=l&&!0===l.is_location_based,v={user_id:i.userInfo.uid,content:u.value.trim(),images:t,videoURL:a,cate_id:d.value,address:r.value.address||"未知地址",district:r.value.district||"未知区域",user_nickName:i.userInfo.nickName,user_avatarUrl:i.userInfo.avatarUrl,user_mobile:i.userInfo.mobile,pay_amount:m.value||0,is_location_based_category:s,category_info:l?{name:l.cate_name,is_location_based:l.is_location_based||!1,location_district:l.location_district||null,icon:l.icon||null,cate_img:l.cate_img||l.icon||null}:null};let h;if(h=z.value?await o.updateArticle(O.value,v):await o.addArticle(v),!h.id&&0!==h.code)throw new Error(h.message||(z.value?"更新失败":"发布失败"));e.index.showToast({title:z.value?"更新成功":"发布成功",icon:"success",duration:1500,success:()=>{setTimeout((()=>{e.index.navigateBack({delta:1,success:()=>{e.index.$emit("globalRefresh",{timestamp:Date.now(),pages:["index","userArticleList","articleDetail"]}),console.log("触发全局刷新事件")}})}),1500)}})}catch(t){console.error(z.value?"更新失败:":"发布失败:",t),e.index.showToast({title:t.message||(z.value?"更新失败，请重试":"发布失败，请重试"),icon:"none"})}finally{e.index.hideLoading()}}else e.index.showToast({title:"未能获取位置信息",icon:"none"})}else e.index.showToast({title:"请输入内容",icon:"none"})},W=async t=>{try{e.index.showLoading({title:"生成图标中...",mask:!1});const a=await H(t.cate_name);if(!a||!a.tempFilePath)throw new Error("生成临时图标失败");F=t,k.value=a.tempFilePath,await G()}catch(a){console.error("生成图标失败:",a),e.index.showToast({title:"生成图标失败",icon:"none"})}finally{e.index.hideLoading()}},H=async t=>{try{e.index.showLoading({title:"生成预览中...",mask:!1});const a=(e=>{let t=0;for(let l=0;l<e.length;l++)t=e.charCodeAt(l)+((t<<5)-t);const a=Math.abs(t)%360,i=40+Math.abs(t)%30,o=75+Math.abs(t)%15;return{background:`hsl(${a}, ${i}%, ${o}%)`,foreground:o>65?"#333333":"#FFFFFF"}})(t),i=200,o=e.index.createOffscreenCanvas({type:"2d",width:i,height:i}),l=o.getContext("2d");l.fillStyle=a.background,l.fillRect(0,0,i,i),l.strokeStyle="rgba(0,0,0,0.1)",l.lineWidth=2,l.strokeRect(2,2,i-4,i-4);const n=t.charAt(0);l.fillStyle=a.foreground;const s=i/2*(U.value/100);l.font=`bold ${s}px sans-serif`,l.textAlign="center",l.textBaseline="middle";const c=i/2+T.value*i/100,r=i/2+R.value*i/100;l.fillText(n,c,r);const u=await new Promise(((t,a)=>{const i=o.toDataURL("image/png"),l=e.index.getFileSystemManager(),n=`${e.index.env.USER_DATA_PATH}/temp_category_icon_${Date.now()}.png`,s=i.replace(/^data:image\/\w+;base64,/,"");l.writeFile({filePath:n,data:s,encoding:"base64",success:()=>t(n),fail:e=>a(new Error(`保存临时文件失败: ${JSON.stringify(e)}`))})}));return e.index.hideLoading(),{tempFilePath:u,colors:a}}catch(a){return e.index.hideLoading(),console.error("生成临时图标失败:",a),null}},q=()=>{e.index.showToast({title:"正在重新获取分类...",icon:"loading",duration:2e3}),setTimeout((()=>{P()}),1e3)};e.onMounted((()=>{console.log("组件已挂载"),y.value=!1,z.value||P().catch((t=>{console.error("onMounted获取分类失败:",t),e.index.showModal({title:"提示",content:"获取分类失败，是否重试？",success:e=>{e.confirm&&q()}})}))}));const B=()=>{0!==n.value.length?n.value[s.value]?W(n.value[s.value]):e.index.showToast({title:"请先选择一个分类",icon:"none",duration:2e3}):e.index.showToast({title:"没有可用分类",icon:"none",duration:2e3})},Q=e=>{const t=e.detail.lineCount||1;let a=Math.max(170,40*t+40);a=Math.min(a,800),Math.abs(f.value-a)>10&&(f.value=a,clearTimeout(window.scrollAdjustTimer),window.scrollAdjustTimer=setTimeout((()=>{V()}),100))},J=async()=>{if(F)try{const e=await H(F.cate_name);e&&e.tempFilePath&&(k.value=e.tempFilePath)}catch(e){console.error("更新预览失败:",e)}},G=async()=>{if(F&&k.value)try{e.index.showLoading({title:"保存中...",mask:!1});const a=await l.getUploadFileOptions({cloudPath:`categories/${F._id||Date.now()}.png`,fileType:"image",isOriginal:!0}),i=await e.index.uploadFile({...a.uploadFileOptions,filePath:k.value,name:"file"});if(200!==i.statusCode)throw new Error(`上传失败: ${i.statusCode}`);const o=a.fileURL,n=a.thumbnailURL;if(F._id)try{const t=await l.updateCategoryIcon({categoryId:F._id,iconURL:o,thumbnailURL:n}).catch((e=>(console.warn("云函数updateCategoryIcon可能未部署或不可用:",e),{updated:!1,error:e.message})));t&&t.updated?(console.log("更新分类图标结果:",t),F.icon=o,F.cate_img=o,F.cate_img_thumbnail=n,L.value=!1,e.index.showToast({title:"图标保存成功",icon:"success"})):(console.warn("更新分类图标未成功，但图标已生成:",{iconURL:o,thumbnailURL:n}),F.icon=o,F.cate_img=o,F.cate_img_thumbnail=n,L.value=!1,e.index.showToast({title:"图标已生成",icon:"success"}))}catch(t){console.error("更新分类图标数据库记录失败:",t),F.icon=o,F.cate_img=o,F.cate_img_thumbnail=n,L.value=!1,e.index.showToast({title:"图标已生成，但未更新数据库",icon:"none"})}}catch(a){console.error("保存图标失败:",a),e.index.showToast({title:"保存图标失败",icon:"none"})}finally{e.index.hideLoading()}else e.index.showToast({title:"没有可保存的图标",icon:"none"})},K=()=>{L.value=!1,F=null,k.value=""},V=()=>{e.nextTick$1((()=>{try{const t=e.index.getSystemInfoSync(),a=t.windowHeight,i=.4*t.windowHeight;e.index.createSelectorQuery().select(".content-area").boundingClientRect((o=>{if(!o)return;const l=o.top+o.height-(a-i)+t.windowWidth/750*100;if(l>0){let t=0;const i=getCurrentPages(),o=i[i.length-1];o&&o.$page&&(t=o.$page.scrollTop||0);const n=t+l;e.index.pageScrollTo({scrollTop:n,duration:200,success:()=>{e.nextTick$1((()=>{l>a/3&&e.index.pageScrollTo({scrollTop:n+50,duration:100})}))}})}})).exec()}catch(t){console.error("调整滚动位置失败:",t)}}))},X=t=>{u.value||(u.value="");const a=u.value.substring(0,p.value),i=u.value.substring(w.value);u.value=a+t+i;const o=p.value+t.length;e.nextTick$1((()=>{p.value=o,w.value=o,v.value=!0,Q({detail:{lineCount:u.value.split("\n").length}})}))},Y=e=>{e.detail&&(p.value=e.detail.selectionStart||0,w.value=e.detail.selectionEnd||0,p.value,w.value)},Z=t=>{try{V();t&&"click"===t.type&&(v.value=!0),!t||"touchstart"!==t.type&&"click"!==t.type||e.index.createSelectorQuery().select(".content-input").boundingClientRect((e=>{e&&(te.value={left:e.left,top:e.top,width:e.width,height:e.height})})).exec()}catch(a){console.log("增强文本选择失败",a)}},ee=t=>{t.preventDefault&&t.preventDefault(),e.index.showActionSheet({itemList:["全选","复制","粘贴","清空"],success:t=>{switch(t.tapIndex){case 0:p.value=0,w.value=u.value.length,v.value=!0,e.index.showToast({title:"已全选",icon:"none",duration:1e3});break;case 1:if(p.value!==w.value){const t=u.value.substring(p.value,w.value);e.index.setClipboardData({data:t,success:()=>{e.index.showToast({title:"已复制",icon:"success",duration:1e3})}})}else u.value?e.index.setClipboardData({data:u.value,success:()=>{e.index.showToast({title:"已复制全部内容",icon:"success",duration:1e3})}}):e.index.showToast({title:"无内容可复制",icon:"none",duration:1e3});break;case 2:e.index.getClipboardData({success:t=>{t.data?(X(t.data),e.index.showToast({title:"已粘贴",icon:"success",duration:1e3})):e.index.showToast({title:"剪贴板为空",icon:"none",duration:1e3})}});break;case 3:e.index.showModal({title:"提示",content:"确定要清空全部内容吗？",success:e=>{e.confirm&&(u.value="",setTimeout((()=>{v.value=!0}),100))}})}}})},te=e.ref({left:0,top:0,width:0,height:0}),ae=()=>{_.value=!1,x.value=""};return(t,a)=>e.e({},{f:n.value.length>0&&n.value[s.value]&&!n.value[s.value].cate_img_thumbnail},n.value.length>0&&n.value[s.value]&&!n.value[s.value].cate_img_thumbnail?{g:e.p({type:"plus",size:"30",color:"#2196F3"}),h:e.o(B)}:{},{i:e.f(n.value,((t,a,i)=>e.e({a:t.icon,b:a===s.value},a===s.value?{c:"5ce928df-2-"+i,d:e.p({type:"checkmarkempty",size:"16",color:"#fff"})}:{},{e:t.is_location_based},(t.is_location_based,{}),{f:e.t(t.cate_name),g:a,h:a===s.value?1:"",i:t.is_location_based?1:"",j:e.o((e=>(e=>{s.value=e,d.value=n.value[e]._id,console.log("选择分类:",n.value[e].cate_name)})(a)),a)}))),j:0===n.value.length||"default"===n.value[0]._id},0===n.value.length||"default"===n.value[0]._id?{k:e.p({type:"refresh",size:"16",color:"#ff6600"}),l:e.o(q)}:{},{m:v.value,n:e.o((e=>v.value=!1)),o:e.o(((...e)=>t.handleTextareaFocus&&t.handleTextareaFocus(...e))),p:p.value,q:w.value,r:e.o((()=>{})),s:e.o(Q),t:e.o([e=>u.value=e.detail.value,Q]),v:e.o(Y),w:e.o(ee),x:e.o(Z),y:e.o(Z),z:u.value,A:e.t(u.value.length),B:e.p({type:"more-filled",size:"16",color:"#666"}),C:e.o(ee),D:f.value+"rpx",E:e.f(c.value,((t,a,i)=>e.e({a:t.thumbnailURL,b:e.o((t=>(t=>{if(!c.value[t])return;const a=c.value.map((e=>e.thumbnailURL));b.value=t,e.index.previewImage({current:t,urls:a,indicator:"number",loop:!0,success:()=>{console.log("图片预览成功")},fail:e=>{console.error("图片预览失败",e),_.value=!0,x.value=a[t]}})})(a)),a),c:"5ce928df-5-"+i,d:e.o((e=>(e=>{c.value.splice(e,1)})(a)),a),e:t.progress<100},t.progress<100?{f:e.t(t.progress.toFixed(0)),g:t.progress+"%"}:{},{h:a}))),F:e.p({type:"close",size:"20",color:"#fff"}),G:e.p({type:"plusempty",size:"30",color:"#999"}),H:e.o(M),I:g.value},g.value?{J:e.t(g.value),K:e.p({type:"close",size:"20",color:"#fff"}),L:e.o(D)}:{M:e.o([e=>h.value=e.detail.value,A]),N:h.value},{O:e.t(z.value?"更新":"发布"),P:e.o(N),Q:L.value},L.value?{R:e.p({type:"close",size:"20",color:"#666"}),S:e.o(K),T:k.value,U:T.value+50,V:e.o((e=>{T.value=e.detail.value-50,J()})),W:R.value+50,X:e.o((e=>{R.value=e.detail.value-50,J()})),Y:U.value,Z:e.o((e=>{U.value=e.detail.value,J()})),aa:e.o(K),ab:e.o(G)}:{},{ac:I.value},I.value?{ad:e.p({type:"close",size:"20",color:"#666"}),ae:e.o((e=>I.value=!1)),af:e.f($.value,((t,a,i)=>({a:e.t(t.name),b:a,c:C.value===a?1:"",d:e.o((e=>(e=>{C.value=e})(a)),a)}))),ag:e.f($.value[C.value].emojis,((t,a,i)=>({a:e.t(t),b:t,c:e.o((e=>(e=>{X(e)})(t)),t)})))}:{},{ah:_.value},_.value?{ai:x.value,aj:e.p({type:"close",size:"24",color:"#fff"}),ak:e.o(ae),al:e.o((()=>{})),am:e.o(ae)}:{},{an:e.gei(t,"")})}}),o=e._export_sfc(i,[["__scopeId","data-v-5ce928df"]]);wx.createPage(o);
