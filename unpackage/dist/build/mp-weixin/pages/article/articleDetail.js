"use strict";const e=require("../../common/vendor.js"),a=require("../../store/user.js"),l=require("../../utils/formatTime.js"),t=require("../../utils/isLogin.js");if(!Array){e.resolveComponent("uni-icons")()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+r+i+n+o)();const o=()=>"../../components/tuijian/tuijian.js",i=()=>"../../components/comment-list/comment-list.js",n=()=>"../../components/articleDetail-choujia/articleDetail-choujia.js",r=()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js",u={__name:"articleDetail",props:{article_id:{type:String,default:""},user_id:String},setup(o){const i=o,n=a.useUserInfoStore(),r=e.ref(!1),u=e.ref(!0);e.ref(!1);const s=e.ref(""),c=e.ref(!0),v=e.ref(!0),d=e.nr.importObject("articleWx",{customUI:!0}),m=e.nr.importObject("commentList",{customUI:!0});e.nr.importObject("likeRecord",{customUI:!0});const g=e.nr.importObject("userWx",{customUI:!0}),h=e.ref(null),f=e.ref(5),p=e.ref(!1);e.ref(!1);const _=e.ref(null);e.computed((()=>w.value.length>=3));const y=e.ref({}),w=e.ref([]),b=e.computed((()=>w.value.length<=5?w.value:w.value.slice(0,f.value))),x=()=>{f.value+=5,f.value>=w.value.length&&(f.value=w.value.length,p.value=!0)},U=()=>{f.value=5,p.value=!1},L=e.computed((()=>w.value.length)),$=e.ref(!1);e.ref(0);const I=e.ref({}),R=e.ref(!0),T=e.ref("loading"),k=e.ref(null),C=e.ref(null),j=e.ref(!1),D=e.ref(null);e.ref(null),e.ref(null),e.ref(!1);const S=(e,a="image")=>e?e.includes("jingle0350.cn")&&"image"===a?(e=>e?e.includes("imageMogr2")||e.includes("watermark")?e:e.includes("?")?`${e}&imageMogr2/thumbnail/!300x300r/format/webp/quality/70`:`${e}?imageMogr2/thumbnail/!300x300r/format/webp/quality/70`:"")(e):e.includes("ixigua.com")||e.includes("aly2.")?e.includes("?")?`${e}&referer=no_referer`:`${e}?referer=no_referer`:("video"===a&&e.includes("baidu.com"),e):"",V=e=>!!e&&(e.startsWith("http")||e.startsWith("https")||e.startsWith("/")||e.startsWith("data:image")),z=e.ref({}),M=e.ref({}),A=e.ref({title:"",path:"",imageUrl:""}),P=()=>{try{let e=y.value.content?y.value.content.substring(0,30):"精彩内容";e.length<15&&y.value.cate_name;let a="";const l=`/pages/article/articleDetail?article_id=${i.article_id}`;A.value={title:e,path:l,imageUrl:a}}catch(e){console.error("更新分享信息失败:",e)}};e.onShareAppMessage((e=>(P(),{title:A.value.title,path:A.value.path,imageUrl:A.value.imageUrl}))),e.onShareTimeline((()=>(P(),{title:A.value.title,path:A.value.path,imageUrl:A.value.imageUrl}))),e.index.$on("setShareInfo",(e=>{e&&(A.value={title:e.title||A.value.title,path:e.path||A.value.path,imageUrl:e.imageUrl||A.value.imageUrl})})),e.onBeforeUnmount((()=>{e.index.$off("setShareInfo")}));const N=async()=>{try{if(await(async()=>{try{return 1===getCurrentPages().length&&(e.index.switchTab({url:"/pages/index/index",success:()=>{setTimeout((()=>{e.index.navigateTo({url:`/pages/article/articleDetail?article_id=${i.article_id}`,animationType:"slide-in-right",animationDuration:300,fail:e=>{console.error("跳转回文章详情页失败:",e)}})}),300)},fail:a=>{console.error("跳转到首页失败:",a);try{e.nr.importObject("cateWx",{customUI:!0}).get().catch((e=>{console.warn("预加载首页数据失败",e)}))}catch(l){console.warn("初始化首页数据失败",l)}}}),!0)}catch(a){return console.error("页面导航错误：",a),!1}})())return;if(!i.article_id)throw new Error("文章ID不能为空");await new Promise((e=>setTimeout(e,50)));const l=await d.getArticleDetal(i.article_id);if(!(l&&l.articleRes&&l.articleRes.data&&Array.isArray(l.articleRes.data)))throw new Error("获取文章详情失败：返回数据格式错误");const t=l.articleRes.data[0];if(t.content||(t.content="暂无内容"),t.videoURL&&(t.videoURL=S(t.videoURL,"video"),T.value="loading"),t.images&&t.images.length?(I.value={},M.value={},Object.keys(z.value).forEach((e=>{clearTimeout(z.value[e])})),z.value={},t.images=t.images.map(((e,a)=>(!e.compressedURL&&e.url&&(e.compressedURL=e.url),e.compressedURL&&(e.compressedURL=S(e.compressedURL,"image")),!e.thumbnailURL&&e.compressedURL&&(e.thumbnailURL=e.compressedURL),V(e.compressedURL)||V(e.thumbnailURL)||V(e.url)||(console.warn(`图片 ${a} 的URL无效:`,e),e.compressedURL="/static/images/default-image.png",e.thumbnailURL="/static/images/default-image.png"),I.value[a]="loading",z.value[a]=setTimeout((()=>{"loading"===I.value[a]&&(console.log(`图片 ${a} 加载超时`),I.value[a]="error",le())}),15e3),e))),R.value=!0,setTimeout((()=>{R.value&&(console.log("图片加载全局超时，强制显示内容"),R.value=!1)}),17e3)):R.value=!1,t.cate_id)try{const a=e.nr.importObject("cateWx",{customUI:!0}),l=await a.get(t.cate_id);l.data&&l.data[0]&&(t.cate_name=l.data[0].cate_name)}catch(a){console.error("获取分类名称失败:",a)}y.value={_id:t._id||"",content:t.content||"",user_id:t.user_id||"",user_nickName:t.user_nickName||"",user_avatarUrl:t.user_avatarUrl||"",user_mobile:t.user_mobile||"",cate_id:t.cate_id||"",cate_name:t.cate_name||"",create_time:t.create_time||Date.now(),look_count:t.look_count||0,like_count:t.like_count||0,comment_count:t.comment_count||0,images:t.images||[],videoURL:t.videoURL||null},w.value=l.comment||[];try{const a=e.nr.importObject("sendOn",{customUI:!0}),l=await a.get();l&&l.data&&l.data.length>0?(C.value={isVisible:void 0===l.data[0].commentVisibility||l.data[0].commentVisibility,title:"评论区"},j.value=void 0!==l.data[0].lotteryVisibility&&l.data[0].lotteryVisibility,console.log("评论区显示状态:",C.value.isVisible),console.log("抽奖模块显示状态:",j.value)):(C.value={isVisible:!0,title:"评论区"},j.value=!1)}catch(a){console.error("获取显示状态失败:",a),C.value={isVisible:!0,title:"评论区"},j.value=!1}}catch(a){console.error("获取文章详情失败：",a),e.index.showToast({title:"获取文章详情失败",icon:"none"})}},O=async()=>{c.value=!0;try{const t=await d.getCommentList(i.article_id);if(t&&0===t.code&&Array.isArray(t.data)){const o={};y.value&&y.value.user_id&&y.value.user_mobile&&(o[y.value.user_id]=y.value.user_mobile),n.userInfo&&n.userInfo.uid&&n.userInfo.mobile&&(o[n.userInfo.uid]=n.userInfo.mobile);const i=t.data.map((e=>{const a={...e,_id:e._id||e.id,nickName:e.nickName||"匿名用户",avatarUrl:e.avatarUrl||"/static/images/default-avatar.png",content:e.content||"",create_time:e.create_time||(new Date).getTime(),likeCount:e.like_count||0,isLiked:e.is_liked||!1};return a.images?Array.isArray(a.images)||(a.images=[a.images]):a.images=[],a.imageUrl&&0===a.images.length&&a.images.push(a.imageUrl),e.mobile&&(o[e.user_id]=e.mobile),a})),r=i.filter((e=>e.user_id&&!o[e.user_id])).map((e=>e.user_id));if(r.length>0)try{const l=e.nr.database(),t=l.collection("user"),i=await t.where({_id:l.command.in(r)}).field({_id:!0,mobile:!0}).get();if(i&&i.data&&i.data.length>0)i.data.forEach((e=>{e._id&&e.mobile&&(o[e._id]=e.mobile)}));else try{const e=await g.getUsersByIds(r);e&&0===e.code&&Array.isArray(e.data)&&e.data.forEach((e=>{e._id&&e.mobile&&(o[e._id]=e.mobile)}))}catch(a){console.error("通过userWx获取用户信息失败:",a)}}catch(l){console.error("从数据库获取用户手机号失败:",l)}const u=i.map((e=>(e.user_id&&o[e.user_id]?e.mobile=o[e.user_id]:"无手机号"===e.mobile&&(e.mobile=""),e)));w.value=u,p.value=u.length<=5,f.value=Math.min(5,u.length)}else console.error("获取评论列表失败: 返回结果无效",t),w.value=[],p.value=!0,f.value=0}catch(t){console.error("获取评论列表出错:",t),e.index.showToast({title:"获取评论失败，请稍后再试",icon:"none"}),w.value=[],p.value=!0,f.value=0}finally{v.value=!1,c.value=!1}};e.watch((()=>w.value.length),((e,a)=>{ce()}));e.onPullDownRefresh((()=>{(async()=>{try{u.value=!0,c.value=!0,H.value||(H.value=[]),Object.keys(z.value).forEach((e=>{clearTimeout(z.value[e])})),I.value={},z.value={},M.value={},R.value=!0,await N(),await O(),await Y(),console.log("页面数据已刷新")}catch(a){console.error("刷新页面数据失败:",a),e.index.showToast({title:"刷新数据失败",icon:"none"})}finally{u.value=!1,c.value=!1,e.index.stopPullDownRefresh()}})()}));const W=async a=>{var l,t,o,i;try{if(!(await e.index.showModal({title:"提示",content:"确定要删除这条评论吗？",confirmText:"删除",confirmColor:"#ff0000"})).confirm)return;e.index.showLoading({title:"删除中...",mask:!0});const n=await d.deleteComment(a);if(0!==n.code)throw new Error(n.message||"删除失败");{const n=w.value.findIndex((e=>e._id===a));if(-1!==n&&(w.value.splice(n,1),f.value>w.value.length&&(f.value=w.value.length),ce(),re.value))for(let e=0;e<9;e++){const e=null==(t=(l=re.value).getPositionById)?void 0:t.call(l,a);if(-1!==e&&void 0!==e){null==(i=(o=re.value).clearPosition)||i.call(o,e);break}}e.index.showToast({title:"删除成功",icon:"success",duration:1500})}}catch(n){console.error("删除失败:",n),e.index.showToast({title:"string"==typeof n?n:n.message||"删除失败",icon:"none"})}finally{e.index.hideLoading()}},E=e.ref(["不错","支持一下","有用","谢谢分享","学习了","点赞","期待更多","很好","厉害","喜欢","太棒了","赞一个","非常好","实用","感谢楼主","分享给朋友","楼主辛苦了","收藏了","关注了","顶一下"]),q=e.ref([]),B=async a=>{try{if(!t.testLogin())return void console.log("用户未登录，已显示登录提示");console.log("用户已登录，继续处理评论"),console.log("收到评论点击事件:",a),a&&void 0!==a.position?(ue.value=a.position,console.log("设置当前评论位置为:",a.position)):ue.value=-1,(()=>{q.value=[];const e=[...E.value],a=Math.min(4,e.length);for(let l=0;l<a;l++){const a=Math.floor(Math.random()*e.length);q.value.push(e[a]),e.splice(a,1)}})(),F.value=!0}catch(l){console.error("评论点击处理失败:",l),e.index.showToast({title:"操作失败，请重试",icon:"none"})}},F=e.ref(!1),H=e.ref([]);e.ref(null);const G=()=>{F.value=!1,s.value=""},J=()=>{e.index.switchTab({url:"/pages/index/index"})},K=async()=>{try{if(!(await Q()))return;if("未填写"===y.value.user_mobile)return e.index.showToast({icon:"none",title:"没有联系方式"});e.index.makePhoneCall({phoneNumber:y.value.user_mobile,fail:a=>{e.index.showToast({title:"拨打电话失败",icon:"none"})}})}catch(a){console.error("拨打电话失败:",a),e.index.showToast({title:"操作失败，请重试",icon:"none"})}},Q=async()=>{if($.value)return!1;$.value=!0;try{if(n.userInfo&&n.userInfo.uid){if(!n.userInfo.mobile)try{const l=e.index.getStorageSync("userInfo");if(l&&l.mobile)n.setUserInfo({...n.userInfo,mobile:l.mobile});else try{const a=e.nr.importObject("userWx",{customUI:!0}),l=await a.getUserInfo(n.userInfo.uid);l&&l.data&&l.data.mobile&&(n.setUserInfo({...n.userInfo,mobile:l.data.mobile}),e.index.setStorageSync("userInfo",{...n.userInfo,mobile:l.data.mobile}))}catch(a){}}catch(a){console.error("获取用户手机号失败:",a)}return $.value=!1,!0}r.value||(r.value=!0,e.index.showLoading({title:"登录中...",mask:!0}));const l=getCurrentPages(),t=l[l.length-1],o=t.route,i=t.options||{};let u="/"+o;const s=[];for(const e in i)i.hasOwnProperty(e)&&s.push(`${e}=${encodeURIComponent(i[e])}`);return s.length>0&&(u+="?"+s.join("&")),r.value&&(e.index.hideLoading(),r.value=!1),e.index.navigateTo({url:`/pages/login/login?redirect=${encodeURIComponent(u)}`,complete:()=>{$.value=!1}}),!1}catch(a){console.error("登录检查失败:",a),r.value&&(e.index.hideLoading(),r.value=!1),e.index.showToast({title:"登录检查失败，请重试",icon:"none",duration:2e3});const l=`/pages/article/articleDetail?article_id=${i.article_id}`,t=encodeURIComponent(l);return setTimeout((()=>{e.index.navigateTo({url:`/pages/login/login?redirect=${t}`,complete:()=>{$.value=!1}})}),1500),!1}finally{$.value=!1}},X=e.ref(!1),Y=async()=>{var a,l;try{if(!i.article_id)return;if(X.value)return void console.log("浏览量更新已在进行中，跳过重复操作");X.value=!0;const t=`viewed_${i.article_id}`,o=e.index.getStorageSync(t),n=Date.now();if(o&&n-o<3e3)return console.log("3秒钟内已浏览过此文章，不增加浏览量"),void(X.value=!1);e.index.setStorageSync(t,n);const r=await d.updateLookCount(i.article_id);if(r&&0===r.code){const t=(null==(a=r.data)?void 0:a.look_count)||((null==(l=y.value)?void 0:l.look_count)||0)+1;y.value&&(y.value.look_count=t,console.log("文章浏览量已更新为:",y.value.look_count)),e.index.$emit("articleViewCountUpdated",{articleId:i.article_id,viewCount:t})}}catch(t){if(console.error("更新浏览量失败:",t),y.value){const a=(y.value.look_count||0)+1;y.value.look_count=a,e.index.$emit("articleViewCountUpdated",{articleId:i.article_id,viewCount:a})}}finally{X.value=!1}};e.onMounted((async()=>{var a;try{u.value=!0,c.value=!0;const l=getCurrentPages(),t=(null==(a=l[l.length-1].$page)?void 0:a.options)||{};if(!(t.article_id||i.article_id))throw new Error("文章ID不能为空");await N(),u.value=!1,y.value.videoURL&&setTimeout((()=>{k.value=e.index.createVideoContext("articleVideo")}),300),O().catch((e=>{console.error("获取评论列表失败:",e),c.value=!1,v.value=!1})),Y().catch((e=>{console.error("更新浏览量失败:",e)})),(()=>{try{if(!y.value||!y.value._id)return;const a={_id:y.value._id,title:y.value.content?y.value.content.substring(0,30):"无标题",content:y.value.content||"",cate_name:y.value.cate_name||"未分类",create_time:y.value.create_time,view_time:Date.now(),images:y.value.images&&y.value.images.length>0?[y.value.images[0]]:[]};let l=e.index.getStorageSync("viewedArticles")||[];const t=l.findIndex((e=>e._id===a._id));-1!==t&&l.splice(t,1),l.unshift(a),l.length>50&&(l=l.slice(0,50)),e.index.setStorageSync("viewedArticles",l)}catch(a){console.error("保存浏览记录失败:",a)}})()}catch(l){console.error("页面初始化失败:",l),e.index.showToast({title:"加载失败，请重试",icon:"none"})}finally{u.value=!1}})),e.onUnmounted((()=>{h.value&&clearInterval(h.value)}));const Z=a=>{if(!y.value.images||!y.value.images.length)return;const l=y.value.images.filter((e=>{const a=e.compressedURL||e.thumbnailURL||e.url;return a&&(a.startsWith("http")||a.startsWith("/"))}));if(0===l.length)return console.log("没有有效的图片可以预览"),void e.index.showToast({title:"图片无法预览",icon:"none"});const t=l.map((e=>e.compressedURL||e.thumbnailURL||e.url));a&&("string"!=typeof a||t.includes(a))||(a=t[0]),console.log(`准备预览图片，有效图片数: ${t.length}，当前图片: ${a}`),e.index.previewImage({current:a,urls:t,indicator:"number",loop:!0,fail:a=>{console.error("预览图片失败:",a),e.index.showToast({title:"预览图片失败",icon:"none"})}})};e.ref(!1),e.ref(0);const ee=e=>{console.log(`图片 ${e} 加载成功`),z.value[e]&&(clearTimeout(z.value[e]),delete z.value[e]),I.value[e]="loaded",le()},ae=e=>{if(console.error("图片加载失败:",e,y.value.images&&y.value.images[e]),z.value[e]&&(clearTimeout(z.value[e]),delete z.value[e]),M.value[e]?M.value[e]++:M.value[e]=1,!y.value||!y.value.images||!y.value.images[e])return I.value[e]="error",void le();if(M.value[e]<=3){const l=y.value.images[e];let t=!1,o="";try{if(1===M.value[e])l.compressedURL!==l.url&&l.url&&(console.log("尝试使用原始URL加载图片:",l.url),o=l.url,t=!0);else if(2===M.value[e]){const e=(new Date).getTime(),a=l.url||l.compressedURL;a&&(o=a.includes("?")?`${a}&t=${e}`:`${a}?t=${e}`,t=!0)}else if(3===M.value[e]){const e=l.url||l.compressedURL;if(e){const a=(new Date).getTime()+1e3;o=e.includes("?")?`${e}&t=${a}&retry=final`:`${e}?t=${a}&retry=final`,t=!0}}if(t&&o){console.log(`图片 ${e} 重试 (${M.value[e]}/3): ${o}`),y.value.images[e]={...y.value.images[e],compressedURL:o},I.value[e]="loading";const a=15e3+5e3*M.value[e];return console.log(`图片 ${e} 设置加载超时: ${a}ms`),void(z.value[e]=setTimeout((()=>{"loading"===I.value[e]&&(console.log(`图片 ${e} 重试后依然超时`),I.value[e]="error",le())}),a))}}catch(a){return console.error("处理图片重试失败:",a),I.value[e]="error",void le()}}I.value[e]="error",console.log(`图片${e}加载失败，已标记为错误状态 (已重试${M.value[e]}次)`),le(),0===e&&setTimeout((()=>{R.value=!1}),300)},le=()=>{if(!y.value||!y.value.images||!y.value.images.length)return void(R.value=!1);const e=y.value.images.length;let a=0,l=0;for(let t=0;t<e;t++)"loaded"===I.value[t]?a++:"error"===I.value[t]&&l++;console.log(`图片加载状态: 已加载 ${a}, 错误 ${l}, 总数 ${e}`),a+l>=e&&(R.value=!1),a>.7*e&&(R.value=!1)},te=a=>{a!==i.article_id&&e.index.navigateTo({url:`/pages/article/articleDetail?article_id=${a}`,success:()=>{},fail:a=>{console.error("跳转到文章详情页失败:",a),e.index.showToast({title:"跳转失败",icon:"none"})}})};e.onReachBottom((()=>{D.value&&D.value.loadMore()}));const oe=()=>{T.value="loaded"},ie=()=>{T.value="error",e.index.showToast({title:"视频加载失败",icon:"none"})};e.index.$on("commentVisibilityChanged",(e=>{console.log("收到评论显示状态变化事件:",e),C.value&&(C.value.isVisible=e)})),e.index.$on("lotteryVisibilityChanged",(e=>{console.log("收到抽奖模块显示状态变化事件:",e),j.value=e})),e.onUnmounted((()=>{e.index.$off("commentVisibilityChanged"),e.index.$off("lotteryVisibilityChanged"),e.index.$off("setShareInfo"),e.index.$off("viewCountUpdated"),e.index.$off("updateArticleLikeStatus")}));const ne=e=>{if("object"==typeof e&&null!==e){const a=[];if(e.nickName){const l=w.value.filter((a=>a.nickName===e.nickName));a.push(...l)}else{const e=[...w.value];if(e.length>0){const l=e[Math.floor(Math.random()*e.length)],t=w.value.filter((e=>e.nickName===l.nickName));a.push(...t)}}_.value=a}else if("string"==typeof e){const e=[...w.value],a=[];if(e.length>0){const l=e[Math.floor(Math.random()*e.length)],t=w.value.filter((e=>e.nickName===l.nickName));a.push(...t)}_.value=a}},re=e.ref(null),ue=e.ref(-1),se=e=>{if(e&&e.userData&&e.userData._id){-1===w.value.findIndex((a=>a._id===e.userData._id))&&(w.value.unshift(e.userData),f.value<w.value.length&&!p.value&&f.value++)}},ce=()=>{y.value&&y.value._id&&(y.value.comment_count=w.value.length,e.index.$emit("commentCountUpdated",{articleId:y.value._id,commentCount:w.value.length}))},ve=()=>{H.value.length>=3?e.index.showToast({title:"最多上传3张图片",icon:"none"}):e.index.chooseImage({count:3-H.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{H.value=[...H.value,...e.tempFilePaths]},fail:e=>{console.error("选择图片失败:",e)}})},de=async()=>{let a=!1;try{if(!t.testLogin())return void e.index.showToast({title:"请先登录",icon:"none"});if(!(s.value.trim()||H.value&&0!==H.value.length))return void e.index.showToast({title:"请输入评论内容或上传图片",icon:"none"});e.index.showLoading({title:"发布中...",mask:!0}),a=!0,H.value||(H.value=[]);let r=[];try{if(H.value.length>0)for(let a=0;a<H.value.length;a++){const t=H.value[a];try{const l=await new Promise(((l,o)=>{e.nr.uploadFile({filePath:t,cloudPath:`comment_images/${Date.now()}_${a}.jpg`,onUploadProgress:e=>{console.log("上传进度:",Math.round(100*e.loaded/e.total))},success:e=>{console.log("图片上传成功:",e),l(e.fileID)},fail:e=>{console.error("图片上传失败:",e),o(e)}})}));r.push(l)}catch(l){throw console.error("图片上传失败:",l),l}}const t={content:s.value.trim(),images:r,article_id:i.article_id,user_id:n.userInfo.uid,nickName:n.userInfo.nickName||"匿名用户",avatarUrl:n.userInfo.avatarUrl||"",mobile:n.userInfo.mobile||"",create_time:Date.now()};console.log("提交评论数据:",t);const o=await m.addComment(t);if(!o||200!==o.code&&0!==o.code)throw new Error(o.message||"评论失败");{s.value="",H.value=[];const l=o.id||o._id;let i={...t,_id:l,create_time:Date.now()};ue.value>=0&&re.value&&(re.value.updatePosition(ue.value,i),ue.value=-1);-1===w.value.findIndex((e=>e._id===l))&&(w.value.unshift(i),f.value<w.value.length&&!p.value&&f.value++),y.value&&y.value._id&&(y.value.comment_count=(y.value.comment_count||0)+1),ce(),a&&(e.index.hideLoading(),a=!1),F.value=!1,e.index.showToast({title:"评论成功",icon:"success",duration:1500})}}catch(o){console.error("[前端] 评论失败:",{error:o,message:o.message,stack:o.stack}),a&&(e.index.hideLoading(),a=!1),e.index.showToast({title:o.message||"评论失败，请稍后重试",icon:"none",duration:2e3})}}catch(o){console.error("评论处理失败:",o),a&&(e.index.hideLoading(),a=!1),e.index.showToast({title:"评论处理失败",icon:"none",duration:2e3})}finally{a&&e.index.hideLoading()}};e.onLoad((async()=>{I.value={},M.value={},Object.keys(z.value).forEach((e=>{clearTimeout(z.value[e])})),z.value={},u.value=!0,R.value=!0;try{await N(),await O(),await Y()}catch(e){console.error("页面加载失败:",e)}finally{u.value=!1}})),e.onShow((()=>{console.log("页面显示")}));const me=(e,a=0)=>{if(!e||!Array.isArray(e)||0===e.length)return void console.log("无图片可预加载");const l=e.length;let t=0,o=0;const i=a=>{if(a>=l)return void(t+o===l?(R.value=!1,console.log(`图片加载完成: 成功 ${t}, 失败 ${o}`)):console.log(`图片加载状态: 已加载 ${t}, 错误 ${o}, 总数 ${l}`));const n=e[a];if(!n)return console.log(`图片 ${a} 为空`),o++,void i(a+1);let r=n.compressedURL||n.thumbnailURL||n.url;if(!r)return console.log(`图片 ${a} 没有有效URL`),o++,void i(a+1);t++,console.log(`标记图片 ${a} 为已加载，URL: ${r.substring(0,50)}${r.length>50?"...":""}`),i(a+1)};i(a)},ge=()=>{setTimeout((()=>{y.value&&y.value.images&&(me(y.value.images),y.value.images.forEach(((e,a)=>{I.value[a]="loaded"})),R.value=!1,console.log("文章已加载完成，标记所有图片为已加载状态"))}),300)};e.watch((()=>y.value._id),(a=>{a&&e.nextTick$1((()=>{ge()}))})),e.watch((()=>u.value),((e,a)=>{!0===a&&!1===e&&ge()}));const he=()=>{n.userInfo&&n.userInfo.uid&&n.userInfo.uid===y.value.user_id?e.index.navigateTo({url:`/pages/fabu/fabu?mode=edit&article_id=${i.article_id}`,fail:a=>{console.error("跳转编辑页面失败:",a),e.index.showToast({title:"跳转失败",icon:"none"})}}):e.index.showToast({title:"只能编辑自己的文章",icon:"none"})};return(a,t)=>e.e({a:u.value&&!y.value._id},u.value&&!y.value._id?{b:e.p({type:"spinner-cycle",size:"48",color:"#399bfe"})}:{},{c:y.value.videoURL},y.value.videoURL?e.e({d:"loading"===T.value},"loading"===T.value?{e:e.p({status:"loading",contentText:{contentrefresh:"视频加载中..."}})}:{},{f:"error"===T.value},"error"===T.value?{g:e.p({type:"videocam-slash",size:"50",color:"#CCCCCC"})}:{},{h:y.value.videoURL,i:y.value.images&&y.value.images[0]?y.value.images[0].compressedURL:"",j:e.o(ie),k:e.o(oe)}):{},{l:y.value.images&&y.value.images.length},y.value.images&&y.value.images.length?e.e({m:e.f(y.value.images.slice(0,y.value.images.length>9?9:y.value.images.length),((a,l,t)=>e.e({a:"error"===I.value[l]},"error"===I.value[l]?{b:"3976918f-3-"+t,c:e.p({type:"image",size:"24",color:"#999999"})}:"loaded"!==I.value[l]?{e:"3976918f-4-"+t,f:e.p({type:"spinner-cycle",size:"24",color:"#666666"})}:{},{d:"loaded"!==I.value[l],g:a.compressedURL||a.thumbnailURL||a.url||"/static/images/default-image.png",h:e.o((e=>ee(l)),l),i:e.o((e=>ae(l)),l),j:"loaded"===I.value[l]?1:0,k:8===l&&y.value.images.length>9},8===l&&y.value.images.length>9?{l:e.t(y.value.images.length-9)}:{},{m:l,n:e.o((e=>Z(a.compressedURL||a.thumbnailURL||a.url)),l)}))),n:e.n({"single-image":1===y.value.images.length,"double-image":2===y.value.images.length,"triple-image":3===y.value.images.length,"grid-image":y.value.images.length>3}),o:y.value.images.length>1},y.value.images.length>1?{p:e.t(y.value.images.length)}:{}):{},{q:e.p({type:"calendar",size:"18",color:"#666666"}),r:e.t(e.unref(l.formatTime)(y.value.create_time)),s:e.p({type:"eye",size:"18",color:"#666666"}),t:e.t(y.value.look_count||0),v:y.value.cate_name},y.value.cate_name?{w:e.p({type:"tag",size:"18",color:"#399bfe"}),x:e.t(y.value.cate_name)}:{},{y:y.value.content},y.value.content?{z:e.t(y.value.content)}:{},{A:C.value&&C.value.isVisible},C.value&&C.value.isVisible?e.e({B:c.value&&!w.value.length},c.value&&!w.value.length?{C:e.p({status:"loading",contentText:{contentrefresh:"评论加载中..."}})}:c.value||0!==w.value.length?{}:{E:e.p({type:"chat",size:"50",color:"#CCCCCC"})},{D:!c.value&&0===w.value.length,F:e.t(L.value),G:e.o(B),H:e.o(W),I:e.p({comments:b.value,articleId:o.article_id,articleUserId:y.value.user_id,showMobile:!0}),J:w.value.length>f.value&&!p.value},w.value.length>f.value&&!p.value?{K:e.t(f.value),L:e.t(w.value.length),M:e.p({type:"bottom",size:"12",color:"#666"}),N:e.o(x)}:{},{O:w.value.length>5&&p.value},w.value.length>5&&p.value?{P:e.p({type:"top",size:"12",color:"#666"}),Q:e.o(U)}:{},{R:C.value&&C.value.isVisible},(C.value&&C.value.isVisible,{}),{S:j.value},j.value?{T:e.sr(re,"3976918f-13",{k:"lotteryDrawRef"}),U:e.o(ne),V:e.o(B),W:e.o(se),X:e.p({commenters:w.value,articleId:o.article_id})}:{}):{},{Y:y.value.images&&y.value.images.length},y.value.images&&y.value.images.length?{Z:e.t(y.value.images.length),aa:e.f(y.value.images,((a,l,t)=>e.e({a:"error"===I.value[l]},"error"===I.value[l]?{b:"3976918f-14-"+t,c:e.p({type:"image",size:"32",color:"#cccccc"})}:"loaded"!==I.value[l]?{e:"3976918f-15-"+t,f:e.p({type:"spinner-cycle",size:"32",color:"#666666"})}:{},{d:"loaded"!==I.value[l],g:a.compressedURL||a.thumbnailURL||a.url||"/static/images/default-image.png",h:e.o((e=>Z(a.compressedURL||a.thumbnailURL||a.url)),l),i:e.o((e=>ee(l)),l),j:e.o((e=>ae(l)),l),k:"loaded"===I.value[l]?1:0,l:l})))}:{},{ab:e.sr(D,"3976918f-16",{k:"tuijianRef"}),ac:e.o(te),ad:e.p({"current-article-id":o.article_id,cate_id:y.value.cate_id}),ae:e.o((e=>{var a;return null==(a=D.value)?void 0:a.loadMore()})),af:y.value._id,ag:e.p({type:"home",size:"24",color:"#444444"}),ah:e.o(J),ai:e.unref(n).userInfo&&e.unref(n).userInfo.uid===y.value.user_id},e.unref(n).userInfo&&e.unref(n).userInfo.uid===y.value.user_id?{aj:e.p({type:"compose",size:"24",color:"#444444"}),ak:e.o(he)}:{},{al:e.o(K),am:F.value},F.value?e.e({an:e.o(G),ao:e.p({type:"close",size:"20",color:"#999"}),ap:e.o(G),aq:e.f(q.value,((a,l,t)=>({a:e.t(a),b:l,c:e.o((e=>(e=>{s.value=e})(a)),l)}))),ar:s.value,as:e.o((e=>s.value=e.detail.value)),at:e.t(s.value.length),av:H.value.length>0},H.value.length>0?{aw:e.f(H.value,((a,l,t)=>({a:a,b:"3976918f-20-"+t,c:e.o((e=>(e=>{H.value.splice(e,1)})(l)),l),d:l}))),ax:e.p({type:"close",size:"16",color:"#fff"})}:{},{ay:H.value.length<3},H.value.length<3?{az:e.p({type:"camera",size:"24",color:"#666"}),aA:e.o(ve)}:{},{aB:e.o(G),aC:e.o(de)}):{},{aD:e.gei(a,"")})}},s=e._export_sfc(u,[["__scopeId","data-v-3976918f"]]);u.__runtimeHooks=6,wx.createPage(s);
