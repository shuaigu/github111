"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),a=require("../../utils/ag.js"),i=require("../../store/user.js");if(!Array){e.resolveComponent("u-checkbox")()}Math;const t={__name:"login",setup(t){const r=i.useUserInfoStore(),n=e.nr.importObject("userWx"),l=e.ref(!1),s=e.ref(!1),c=e.ref("");e.onMounted((()=>{const e=getCurrentPages(),o=e[e.length-1].options||{};o.redirect&&(c.value=decodeURIComponent(o.redirect),console.log("获取到重定向URL:",c.value))}));const d=o=>{console.log(o);let i="";"vipServer"===o?(i=a.vipServer,console.log("服务")):"privacyAgreement"===o&&(i=a.privacyAgreement,console.log("隐私")),e.index.navigateTo({url:`/pages/webview/webview?url=${encodeURIComponent(i)}`})};let u;const v=async()=>{l.value||(l.value=!0,await new Promise((e=>setTimeout(e,100))));const o=await e.index.login();u=o.code,s.value=!0},g=e.ref({uid:"",nickName:"",avatarUrl:"/static/defalut.png",mobile:"",isLogin:!1,role:[],openid_wx:""}),m=async o=>{console.log(o);let a={code:u,encryptedData:o.detail.encryptedData,iv:o.detail.iv};if(console.log(a,"构建"),"getPhoneNumber:ok"!==o.detail.errMsg)throw new Error("获取手机号失败");{const o=await n.loginByPhoneWx(a);if(console.log(o,"服务器返回"),!o.data._id)throw new Error("登录失败");s.value=!1,g.value={uid:o.data._id,nickName:o.data.nickName,avatarUrl:o.data.avatarUrl||"/static/images/defalut.png",mobile:o.data.mobile,isLogin:!0,role:o.data.role,openid_wx:o.data.openid_wx},console.log(g.value,"用户登录成功"),r.setUserInfo(g.value),e.index.showToast({icon:"success",title:o.message}),setTimeout((()=>{p()}),500)}},p=()=>{e.index.$emit("loginSuccess"),c.value?(console.log("正在重定向到:",c.value),e.index.redirectTo({url:c.value,fail:o=>{console.error("重定向失败:",o),e.index.navigateBack({delta:1,fail:()=>{e.index.switchTab({url:"/pages/index/index"})}})}})):e.index.navigateBack({delta:1,fail:()=>{e.index.switchTab({url:"/pages/index/index"})}})};return(a,i)=>e.e({a:o._imports_0,b:e.o((e=>{l.value=e})),c:e.p({activeColor:"#46b0fe",name:"agree",checked:l.value,shape:"circle"}),d:e.o((e=>d("vipServer"))),e:e.o((e=>d("privacyAgreement"))),f:e.o(v),g:s.value},s.value?{h:o._imports_1,i:e.o((e=>s.value=!1)),j:e.o(m)}:{},{k:e.gei(a,"")})}},r=e._export_sfc(t,[["__scopeId","data-v-aac00dbc"]]);wx.createPage(r);
