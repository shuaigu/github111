"use strict";const e=require("../../common/vendor.js"),o=require("../../store/user.js"),t=require("../../utils/isLogin.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const a={__name:"qiniuyun",setup(a){const l=o.useUserInfoStore(),s=e.nr.importObject("qiniuyunCloud",{customUI:!0});e.nr.importObject("ext-storage-co",{customUI:!0});const i=e.nr.importObject("articleWx",{customUI:!0});e.ref([]);const n=e.ref([]),r=e.ref(null),u=e.ref(!1),c=e.ref(0);e.ref([]);const d=e.ref("image"),v=e.ref(""),g=e.ref(null),h=e.ref([]),p=e.ref(0),m=e.ref(null),f=e.ref(!1),w=e.ref(null),x=e.computed((()=>null!==r.value)),y=async()=>{try{const o=e.index.getStorageSync("categoryList");if(o)h.value=JSON.parse(o).map((e=>({...e,cate_img:T(e.cate_img)}))),console.log("从本地存储获取分类成功:",h.value);else{const o=await i.getCategories();o&&o.length>0?(h.value=o.map((e=>({...e,cate_img:T(e.cate_img)}))),e.index.setStorageSync("categoryList",JSON.stringify(o)),console.log("从数据库获取分类成功:",h.value)):(h.value=L(),console.log("使用默认分类:",h.value))}}catch(o){console.error("获取本地分类失败:",o),h.value=L()}},L=()=>[{_id:"default_1",cate_name:"默认分类1",cate_img:"/static/category/default1.png"},{_id:"default_2",cate_name:"默认分类2",cate_img:"/static/category/default2.png"},{_id:"default_3",cate_name:"默认分类3",cate_img:"/static/category/default3.png"},{_id:"default_4",cate_name:"默认分类4",cate_img:"/static/category/default4.png"}],T=e=>e?e.startsWith("http")||e.startsWith("/")||e.includes("://")?e:`https://your-qiniu-domain.com/${e}`:"/static/category/default.png",U=()=>(console.log("检查用户登录状态:",l.userInfo),!(!l.userInfo||!l.userInfo.uid)||(console.log("用户未登录，调用登录函数"),e.index.showToast({title:"请先登录",icon:"none"}),t.testLogin(),!1));e.onMounted((()=>{console.log("发布页面已加载"),(async()=>{try{e.index.showLoading({title:"加载中..."});const o=await e.index.getLocation({type:"gcj02"}).catch((e=>(console.error("获取位置失败:",e),{longitude:0,latitude:0}))),t=await i.addReady(`${o.longitude},${o.latitude}`);console.log("获取位置和分类:",t),t?(g.value={address:t.address||"未知位置",district:t.district||""},t.cateList&&t.cateList.length>0?(h.value=t.cateList.map((e=>({...e,cate_img:T(e.cate_img)}))),m.value=null,p.value=-1):await y()):await y(),e.index.hideLoading()}catch(o){console.error("获取位置和分类失败:",o),e.index.hideLoading(),await y(),e.index.showToast({title:"获取信息失败",icon:"none"})}})();const o=getCurrentPages(),t=o[o.length-1];if(t&&t.$getAppWebview){t.$getAppWebview().setStyle({popGesture:"none"})}})),e.onBeforeUnmount((()=>{console.log("发布页面即将卸载");(n.value.some((e=>"uploading"===e.uploadStatus))||r.value&&"uploading"===r.value.uploadStatus)&&!f.value&&console.log("有正在上传的媒体文件，但用户选择离开页面"),w.value&&!f.value&&(console.log("页面卸载前再次触发刷新事件"),e.index.$emit("refreshIndexOnce",w.value))})),e.onUnmounted((()=>{console.log("发布页面已完全卸载")}));const S=async()=>{try{if(!U())return;if(n.value.length>=9)return void e.index.showToast({title:"最多只能上传9张图片",icon:"none"});e.index.showActionSheet({itemList:["从相册选择","拍照"],success:async o=>{let t=[];switch(o.tapIndex){case 0:t=["album"];break;case 1:t=["camera"]}const a=await e.index.chooseImage({count:9-n.value.length,sizeType:["original","compressed"],sourceType:t});console.log("选择图片结果:",a);const l=a.tempFilePaths.map((e=>{const o=e.replace(/^kwfile:\/\//,"");return{type:"image",tempPath:o,thumbnailURL:o,progress:0,uploadStatus:null}})),s=n.value.length;n.value.push(...l);for(let i=0;i<l.length;i++){const o=s+i;setTimeout((()=>{R(n.value[o],o).then((e=>{console.log(`图片${o}上传成功:`,e),n.value[o]&&(n.value[o]={...n.value[o],...e,progress:100,uploadStatus:"success"})})).catch((t=>{console.error(`图片${o}上传失败:`,t),n.value[o]&&(n.value[o].uploadStatus="error"),e.index.showToast({title:`第${o+1}张图片上传失败`,icon:"none"})}))}),200*i)}}})}catch(o){"chooseImage:fail cancel"!==o.errMsg&&e.index.showToast({title:"选择图片失败",icon:"none"})}},_=e=>{if(!e)return"";let o=e.replace(/^kwfile:\/\//,"");return o.startsWith("http")||o.startsWith("tmp/"),o},b=async()=>{try{if(!U())return;if(x.value)return void e.index.showToast({title:"只能选择一个视频",icon:"none"});e.index.showActionSheet({itemList:["从相册选择","拍摄视频"],success:async o=>{let t=[];switch(o.tapIndex){case 0:t=["album"];break;case 1:t=["camera"]}const a=await e.index.chooseVideo({sourceType:t,maxDuration:60,camera:"back"});console.log("选择视频结果:",a);if(a.size>524288e3)e.index.showToast({title:"视频过大，请选择小于500MB的视频",icon:"none"});else{r.value={type:"video",tempPath:a.tempFilePath,poster:a.thumbTempFilePath,thumbnailURL:a.thumbTempFilePath,duration:a.duration,size:a.size,width:a.width,height:a.height,format:"mp4",progress:0,uploadStatus:"uploading"},e.index.showToast({title:"准备上传视频",icon:"loading",duration:2e3});try{k(r.value).then((o=>{console.log("视频上传成功:",o),r.value={...r.value,...o,progress:100,uploadStatus:"success"},e.index.showToast({title:"视频上传成功",icon:"success",duration:2e3})})).catch((o=>{console.error("视频上传失败:",o),r.value&&(r.value.uploadStatus="error",e.index.showToast({title:"视频上传失败，可继续编辑内容",icon:"none",duration:2e3}))})),e.index.showToast({title:"视频上传中，您可继续编辑",icon:"none",duration:2e3})}catch(l){console.error("启动视频上传失败:",l),r.value&&(r.value.uploadStatus="error"),e.index.showToast({title:"启动视频上传失败",icon:"none",duration:2e3})}}}})}catch(o){"chooseVideo:fail cancel"!==o.errMsg&&e.index.showToast({title:"选择视频失败",icon:"none"})}},$=()=>{r.value=null},R=async(o,t)=>{try{o.uploadStatus="uploading";const t=I(o.tempPath),a=await s.generateUploadToken({type:"image",ext:t});if(console.log("获取七牛云上传凭证成功:",a),!a||!a.token)throw new Error("获取上传凭证失败");let l=a.uploadDomain;return l&&!l.startsWith("https://")&&(l=l.replace("http://","https://"),console.log("已将上传域名转换为HTTPS:",l)),new Promise(((t,s)=>{let i=0;const n=()=>{try{e.index.uploadFile({url:l,filePath:o.tempPath,name:"file",formData:{token:a.token,key:a.key},success:e=>{if(console.log("上传响应:",e),200===e.statusCode)try{JSON.parse(e.data);const l=`${a.domain}/${a.key}`;o.uploadStatus="success",o.fileURL=l,o.progress=100;const s=`${l}?imageView2/1/w/200/h/200`;t({type:"image",url:l,thumbnailURL:s,compressedURL:`${l}?imageView2/2/w/800`})}catch(l){console.error("解析上传响应失败:",l),o.uploadStatus="error",s(new Error("解析上传响应失败"))}else console.error("上传失败状态码:",e.statusCode),o.uploadStatus="error",s(new Error(`上传失败: ${e.statusCode}`))},fail:t=>(console.error("上传失败:",t),t.errMsg&&t.errMsg.includes("url not in domain list")?(e.index.showModal({title:"上传域名未授权",content:"请在微信小程序管理后台添加 "+l+" 到合法域名列表",showCancel:!1}),o.uploadStatus="error",void s(new Error(t.errMsg||"上传失败"))):t.errMsg&&t.errMsg.includes("exceed max upload connection count")&&i<3?(i++,console.log(`连接数超限，第${i}次重试上传图片...`),void setTimeout((()=>{n()}),1e3*i)):(o.uploadStatus="error",void s(new Error(t.errMsg||"上传失败"))))}).onProgressUpdate((e=>{o.progress=e.progress,M()}))}catch(r){console.error("创建上传任务失败:",r),o.uploadStatus="error",s(new Error("创建上传任务失败: "+r.message))}};n()}))}catch(a){throw console.error("上传图片错误:",a),o.uploadStatus="error",new Error(`上传失败：${a.message}`)}},k=async o=>{try{o.uploadStatus="uploading";const t=I(o.tempPath),a=await s.generateUploadToken({type:"video",ext:t});if(console.log("获取七牛云上传凭证成功:",a),!a||!a.token)throw new Error("获取上传凭证失败");let l=a.uploadDomain;l&&!l.startsWith("https://")&&(l=l.replace("http://","https://"),console.log("已将上传域名转换为HTTPS:",l));const i=a.videoStyle||"standard",n=a.styleSeparator||"-";return e.index.showToast({title:"开始上传视频",icon:"loading",duration:2e3}),new Promise(((t,s)=>{let r=Date.now(),u=0,c=0,d="计算中...",v=0;let g=0;const h=()=>{try{e.index.uploadFile({url:l,filePath:o.tempPath,name:"file",formData:{token:a.token,key:a.key},success:l=>{if(console.log("上传响应:",l),200===l.statusCode)try{const s=JSON.parse(l.data),r=`${a.domain}/${a.key}`;o.uploadStatus="success",o.videoURL=r,o.progress=100;const u=`${r}?vframe/jpg/offset/1`,c=i?`${r}${n}${i}`:r;e.index.showToast({title:"视频上传成功",icon:"success",duration:2e3}),t({type:"video",videoURL:r,thumbnailURL:u,playURL:c,duration:s.duration?parseInt(s.duration):o.duration,size:o.size,width:o.width,height:o.height,format:o.format||"mp4"})}catch(r){console.error("解析上传响应失败:",r),o.uploadStatus="error",e.index.showToast({title:"解析响应失败",icon:"none",duration:2e3}),s(new Error("解析上传响应失败"))}else console.error("上传失败状态码:",l.statusCode),o.uploadStatus="error",e.index.showToast({title:`上传失败: ${l.statusCode}`,icon:"none",duration:2e3}),s(new Error(`上传失败: ${l.statusCode}`))},fail:t=>(console.error("上传失败:",t),t.errMsg&&t.errMsg.includes("url not in domain list")?(e.index.showModal({title:"上传域名未授权",content:"请在微信小程序管理后台添加 "+l+" 到合法域名列表",showCancel:!1}),o.uploadStatus="error",void s(new Error(t.errMsg||"上传失败"))):t.errMsg&&t.errMsg.includes("exceed max upload connection count")&&g<3?(g++,console.log(`连接数超限，第${g}次重试上传视频...`),e.index.showToast({title:`连接数超限，正在重试(${g}/3)`,icon:"none",duration:2e3}),void setTimeout((()=>{h()}),2e3*g)):(o.uploadStatus="error",e.index.showToast({title:"上传失败，请重试",icon:"none",duration:2e3}),void s(new Error(t.errMsg||"上传失败"))))}).onProgressUpdate((t=>{o.progress=t.progress,((t,a)=>{const l=Date.now(),s=(l-r)/1e3;if(s>1){u=(a-c)/s;const i=o.size-a,n=u>0?i/u:0;d=n>60?`约${Math.ceil(n/60)}分钟`:`约${Math.ceil(n)}秒`;let g="";g=u>1048576?`${(u/1048576).toFixed(2)}MB/s`:u>1024?`${(u/1024).toFixed(2)}KB/s`:`${Math.floor(u)}B/s`,l-v>3e3&&(e.index.showToast({title:`上传中: ${t}%`,icon:"none",duration:1500}),v=l),r=l,c=a}})(t.progress,t.totalBytesWritten),M()}))}catch(p){console.error("创建上传任务失败:",p),o.uploadStatus="error",e.index.showToast({title:"创建上传任务失败",icon:"none",duration:2e3}),s(new Error("创建上传任务失败: "+p.message))}};h()}))}catch(t){throw console.error("上传视频错误:",t),o.uploadStatus="error",e.index.showToast({title:"上传失败: "+t.message,icon:"none",duration:2e3}),new Error(`上传失败：${t.message}`)}},I=e=>{const o=e.lastIndexOf(".");return o>0?e.substring(o+1).toLowerCase():""},M=()=>{let e=n.value.length+(r.value?1:0),o=0;n.value.forEach((e=>{o+=e.progress||0})),r.value&&(o+=r.value.progress||0),c.value=e>0?Math.floor(o/e):0},P=async()=>{try{if(f.value)return void console.log("发布请求正在处理中，请勿重复提交");if(f.value=!0,!U())return void(f.value=!1);if(!m.value)return e.index.showToast({title:"请选择分类",icon:"none"}),void(f.value=!1);if(!v.value.trim())return e.index.showToast({title:"请输入文字内容",icon:"none",duration:2e3}),void(f.value=!1);if(v.value.trim().length<5)return e.index.showToast({title:"文字内容需大于5个字符",icon:"none",duration:2e3}),void(f.value=!1);if(n.value.some((e=>"uploading"===e.uploadStatus))||r.value&&"uploading"===r.value.uploadStatus)return void e.index.showModal({title:"媒体文件正在上传",content:"有媒体文件正在上传中，是否等待上传完成后再发布？",confirmText:"等待上传",cancelText:"仅发布文字",success:o=>{o.confirm?(e.index.showToast({title:"请等待上传完成",icon:"none",duration:2e3}),f.value=!1):z()}});await E()}catch(o){console.error("发布失败:",o),e.index.hideLoading(),e.index.showToast({title:o.message||"发布失败",icon:"none"}),u.value=!1,f.value=!1}},z=async()=>{var o,t,a;try{e.index.showLoading({title:"正在发布...",mask:!0});const s={user_id:l.userInfo.uid,content:v.value.trim(),cate_id:m.value,cate_name:(null==(o=h.value[p.value])?void 0:o.cate_name)||"",address:(null==(t=g.value)?void 0:t.address)||"",district:(null==(a=g.value)?void 0:a.district)||"",user_nickName:l.userInfo.nickName,user_avatarUrl:l.userInfo.avatarUrl,user_mobile:l.userInfo.mobile,state:1},u=n.value.filter((e=>"success"===e.uploadStatus&&!e.loadError)).map((e=>({type:"image",url:e.fileURL,thumbnailURL:e.thumbnailURL,compressedURL:e.compressedURL})));u.length>0&&(s.mediaType="image",s.images=u),r.value&&"success"===r.value.uploadStatus&&(s.mediaType="video",s.video={type:"video",videoURL:r.value.videoURL,thumbnailURL:r.value.thumbnailURL,playURL:r.value.playURL||r.value.videoURL,duration:r.value.duration,size:r.value.size,width:r.value.width,height:r.value.height,format:r.value.format||"mp4"}),console.log("发布数据(仅已上传完成的媒体):",s);const c=await i.addArticle(s);C(c)}catch(s){console.error("发布失败:",s),e.index.hideLoading(),e.index.showToast({title:s.message||"发布失败",icon:"none"}),u.value=!1,f.value=!1}},E=async()=>{var o,t,a;try{u.value=!0,e.index.showLoading({title:"正在发布...",mask:!0});const s=n.value.filter((e=>"success"===e.uploadStatus&&!e.loadError)).map((e=>({type:"image",url:e.fileURL,thumbnailURL:e.thumbnailURL,compressedURL:e.compressedURL})));let c=null;r.value&&"success"===r.value.uploadStatus&&(c={type:"video",videoURL:r.value.videoURL,thumbnailURL:r.value.thumbnailURL,playURL:r.value.playURL||r.value.videoURL,duration:r.value.duration,size:r.value.size,width:r.value.width,height:r.value.height,format:r.value.format||"mp4"});const d={user_id:l.userInfo.uid,content:v.value.trim(),cate_id:m.value,cate_name:(null==(o=h.value[p.value])?void 0:o.cate_name)||"",address:(null==(t=g.value)?void 0:t.address)||"",district:(null==(a=g.value)?void 0:a.district)||"",user_nickName:l.userInfo.nickName,user_avatarUrl:l.userInfo.avatarUrl,user_mobile:l.userInfo.mobile,state:1};s.length>0&&(d.mediaType="image",d.images=s),c&&(d.mediaType="video",d.video=c),console.log("发布数据:",d);const f=await i.addArticle(d);C(f)}catch(s){console.error("发布失败:",s),e.index.hideLoading(),e.index.showToast({title:s.message||"发布失败",icon:"none"}),u.value=!1,f.value=!1}},C=o=>{if(!o.id)throw new Error(o.message||"发布失败");e.index.hideLoading(),e.index.showToast({title:"发布成功",icon:"success"}),v.value="",n.value=[],r.value=null,w.value=o.id,setTimeout((()=>{e.index.$emit("articlePublished",w.value);const o=getCurrentPages();console.log("当前页面栈:",o),o.length>1?e.index.navigateBack({delta:1,success:()=>{console.log("成功返回上一页"),e.index.$emit("refreshIndexOnce",w.value)},fail:e=>{console.error("返回上一页失败:",e),O(w.value)}}):O(w.value)}),1500),u.value=!1,f.value=!1},O=o=>{console.log("准备跳转到首页，文章ID:",o),e.index.switchTab({url:"/pages/index/index",success:()=>{console.log("成功跳转到首页"),setTimeout((()=>{e.index.$emit("refreshIndexOnce",o)}),500)},fail:t=>{console.error("跳转到首页失败:",t),e.index.reLaunch({url:"/pages/index/index",success:()=>{console.log("使用reLaunch成功跳转到首页"),setTimeout((()=>{e.index.$emit("refreshIndexOnce",o)}),500)},fail:o=>{console.error("所有导航方法都失败了:",o),e.index.showToast({title:"跳转首页失败，请手动返回",icon:"none",duration:3e3})}})}})};return(o,t)=>e.e({a:g.value},g.value?{b:e.p({type:"location",size:"14",color:"#007AFF"}),c:e.t(g.value.address)}:{},{d:e.f(h.value,((o,t,a)=>({a:o.cate_img,b:e.o((e=>(e=>{console.error(`分类图片加载错误，索引: ${e}`,h.value[e]),h.value[e]&&(h.value[e].cate_img="/static/category/default.png")})(t)),o._id),c:e.t(o.cate_name),d:o._id,e:m.value===o._id?1:"",f:e.o((e=>(e=>{console.log("选择分类:",h.value[e]),p.value=e,m.value=h.value[e]._id})(t)),o._id)}))),e:0===h.value.length},0===h.value.length?{f:e.p({type:"spinner-cycle",size:"30",color:"#399bfe"})}:{},{g:v.value,h:e.o((e=>v.value=e.detail.value)),i:e.t(v.value.length),j:e.p({type:"image",size:"20",color:"image"===d.value?"#399bfe":"#999"}),k:"image"===d.value?1:"",l:"image"===d.value?1:"",m:e.o((e=>d.value="image")),n:e.p({type:"videocam",size:"20",color:"video"===d.value?"#399bfe":"#999"}),o:"video"===d.value?1:"",p:"video"===d.value?1:"",q:e.o((e=>d.value="video")),r:"image"===d.value||n.value.length>0&&"video"===d.value},"image"===d.value||n.value.length>0&&"video"===d.value?e.e({s:"image"!==d.value&&n.value.length>0},("image"!==d.value&&n.value.length,{}),{t:e.f(n.value,((o,t,a)=>e.e({a:_(o.tempPath||o.thumbnailURL),b:e.o((o=>(o=>{console.error(`图片加载错误，索引: ${o}`,n.value[o]),n.value[o]&&(n.value[o].loadError=!0,e.index.showToast({title:"图片加载失败",icon:"none"}))})(t)),t),c:o.progress<100},o.progress<100?{d:e.t(o.progress),e:o.progress+"%"}:{},{f:"ebc52c84-4-"+a,g:e.o((e=>(e=>{n.value.splice(e,1)})(t)),t),h:t}))),v:e.p({type:"close",size:"16",color:"#fff"}),w:n.value.length<9&&"image"===d.value},n.value.length<9&&"image"===d.value?{x:e.p({type:"plusempty",size:"30",color:"#999"}),y:e.o(S)}:{},{z:"image"===d.value},(d.value,{})):{},{A:"video"===d.value||x.value&&"image"===d.value},"video"===d.value||x.value&&"image"===d.value?e.e({B:"video"!==d.value&&x.value},("video"!==d.value&&x.value,{}),{C:x.value},x.value?e.e({D:r.value.poster||r.value.thumbnailURL,E:e.p({type:"videocam-filled",size:"30",color:"#fff"}),F:e.t(Math.floor(r.value.duration||0)),G:e.t(((r.value.size||0)/1024/1024).toFixed(1)),H:e.t(r.value.format||"mp4"),I:r.value&&r.value.progress<100},r.value&&r.value.progress<100?{J:e.t(r.value.progress),K:r.value.progress+"%"}:{},{L:e.p({type:"close",size:"16",color:"#fff"}),M:e.o($)}):{},{N:!x.value&&"video"===d.value},x.value||"video"!==d.value?{}:{O:e.p({type:"videocam-filled",size:"40",color:"#999"}),P:e.o(b)},{Q:"video"===d.value&&!x.value},("video"!==d.value||x.value,{})):{},{R:e.o(P),S:e.gei(o,"")})}};wx.createPage(a);
