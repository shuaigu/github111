"use strict";const e=require("../../common/vendor.js"),a={__name:"subChoujiang",setup(a){const l=e.ref(!1),t=e.ref(!1),u=e.ref(!1),n=e.ref([]),v=e.ref([]),s=e.ref(-1),o=e.ref(!1),i=e.ref(null),r=e.ref(100),c=e.ref(0),d=e.ref(50),m=e.ref(0),p=e.ref(null),f=e.ref(!0),y=e.ref(null),g=e.ref(0),h=e.ref(""),x=e.ref(-1),w=[{id:"empty",name:"谢谢参与"},{id:"small",name:"小额奖品"},{id:"medium",name:"中额奖品"},{id:"large",name:"大额奖品"}],z=e.reactive({}),b=e.reactive({empty:.4,small:.35,medium:.15,large:.1}),T=e.computed((()=>n.value&&0!==n.value.length?n.value.filter((e=>e&&"center"!==e.type)).map((e=>e.name)):[])),F=e.computed((()=>Math.abs(P()-100)<.1)),I=()=>{n.value.forEach(((e,a)=>{if(e)if("center"===e.type)z[a]=-1;else{const l=e.prizeType||("empty"===e.type?"empty":"small"),t=w.findIndex((e=>e.id===l));z[a]=t>=0?t:0}}))},P=()=>(100*(b.empty+b.small+b.medium+b.large)).toFixed(1),j=(e,a)=>{b[e]=a},C=()=>{if(u.value=!0,h.value){const e=[0,1,2,3,5,6,7,8],a=Math.floor(Math.random()*e.length);x.value=v.value.findIndex((l=>l===e[a]));const l={name:h.value,type:"reward",prizeType:"custom"};y.value={success:!0,prize:l,selectedIndex:e[a],targetPosition:x.value}}else{const e=n.value.filter((e=>e&&"center"!==e.type));if(e.length>0&&g.value<e.length){const a=e[g.value],l=n.value.findIndex((e=>e&&e.name===a.name));l>=0&&(x.value=v.value.findIndex((e=>e===l)),y.value={success:!0,prize:a,selectedIndex:l,targetPosition:x.value})}}t.value=!1,e.index.showToast({title:"奖品已指定",icon:"success"})},M=async()=>{if(F.value)try{const a=await e.nr.callFunction({name:"choujiangWx",data:{method:"updateProbability",data:{probability:b}}});a&&a.result&&a.result.success?(l.value=!1,e.index.showToast({title:"设置已保存",icon:"success"})):e.index.showToast({title:a&&a.result&&a.result.message||"保存失败",icon:"none"})}catch(a){e.index.showToast({title:"保存设置失败",icon:"none"}),console.error(a)}else e.index.showToast({title:"概率总和必须为100%",icon:"none"})},q=()=>{i.value=setTimeout((()=>{c.value++;let e=c.value%v.value.length;s.value=v.value[e],c.value<d.value?(r.value-=10,r.value<40&&(r.value=40)):c.value>d.value+10&&(e>m.value&&0===m.value||e===m.value)?r.value+=110:r.value+=20,c.value>d.value+10&&e===m.value?(clearTimeout(i.value),o.value=!1,W()):q()}),r.value)},W=()=>{if(y.value&&y.value.prize){const e=y.value.prize;let a="";a="empty"===e.type?"很遗憾，谢谢参与！":`恭喜您获得${e.name}！`,p.value={prize:e,message:a}}else{const e=n.value[s.value];if(!e)return;let a="";a="empty"===e.type?"很遗憾，谢谢参与！":`恭喜您获得${e.name}！`,p.value={prize:e,message:a}}},E=()=>{s.value=-1,p.value=null,u.value&&(u.value=!1,y.value=null,h.value="")};return e.onMounted((()=>{(async()=>{try{f.value=!0;const a=await e.nr.callFunction({name:"choujiangWx",data:{method:"getPrizes"}});a&&a.result&&a.result.success?(n.value=a.result.prizes||[],v.value=a.result.sequence||[],a.result.probabilityConfig&&Object.assign(b,a.result.probabilityConfig),I()):e.index.showToast({title:a&&a.result&&a.result.message||"获取奖品数据失败",icon:"none"})}catch(a){e.index.showToast({title:"获取奖品数据失败",icon:"none"}),console.error(a)}finally{f.value=!1}})()})),(a,v)=>e.e({a:l.value},l.value?e.e({b:e.o((e=>l.value=!1)),c:a.prize&&"center"!==a.prize.type},a.prize&&"center"!==a.prize.type?{d:e.f(n.value,((a,l,t)=>e.e({a:a.name,b:e.o((e=>a.name=e.detail.value),l),c:"center"!==a.type&&void 0!==z[l]},"center"!==a.type&&void 0!==z[l]?{d:e.t(z[l]>=0?w[z[l]].name:""),e:z[l],f:w,g:e.o((e=>((e,a)=>{const l=a.detail.value;if(z[e]=l,!n.value[e])return;const t=w[l].id;n.value[e].type="empty"===t?"empty":"reward",n.value[e].prizeType=t})(l,e)),l)}:{},{h:l})))}:{},{e:(100*b.empty).toFixed(1),f:e.o((e=>j("empty",parseFloat(e.detail.value)/100))),g:(100*b.small).toFixed(1),h:e.o((e=>j("small",parseFloat(e.detail.value)/100))),i:(100*b.medium).toFixed(1),j:e.o((e=>j("medium",parseFloat(e.detail.value)/100))),k:(100*b.large).toFixed(1),l:e.o((e=>j("large",parseFloat(e.detail.value)/100))),m:e.t(P()),n:e.t(F.value?"":"(需调整为100%)"),o:F.value?"":1,p:e.o(M)}):{},{q:t.value},t.value?e.e({r:e.o((e=>t.value=!1)),s:n.value.length>0},n.value.length>0?{t:e.t(T.value[g.value]),v:g.value,w:T.value,x:e.o((e=>g.value=parseInt(e.detail.value)))}:{},{y:h.value,z:e.o((e=>h.value=e.detail.value)),A:e.o(C)}):{},{B:!l.value&&!t.value&&!o.value},l.value||t.value||o.value?{}:{C:e.o((e=>l.value=!0)),D:e.o((e=>t.value=!0)),E:e.t(u.value?"手动指定":"随机抽奖")},{F:!l.value&&!t.value},l.value||t.value?{}:{G:e.f(n.value,((a,l,t)=>({a:e.t(a?a.name:""),b:l,c:e.n({active:s.value===l}),d:e.n({center:a&&"center"===a.type}),e:e.o((l=>(async(a,l)=>{if(a&&"center"===a.type&&!o.value){p.value=null;try{if(u.value&&y.value)m.value=y.value.targetPosition>=0?y.value.targetPosition:0,o.value=!0,c.value=0,r.value=100,q();else{u.value=!1;const a=await e.nr.callFunction({name:"choujiangWx",data:{method:"doLottery",data:{userId:"test-user"}}});a&&a.result&&a.result.success?(m.value=a.result.targetPosition,o.value=!0,c.value=0,r.value=100,q(),y.value=a.result):e.index.showToast({title:a&&a.result&&a.result.message||"抽奖失败",icon:"none"})}}catch(t){e.index.showToast({title:"抽奖失败，请重试",icon:"none"}),console.error(t)}}})(a)),l)})))},{H:p.value&&!l.value&&!t.value},!p.value||l.value||t.value?{}:{I:e.t(p.value.message),J:e.o(E)},{K:e.gei(a,"")})}};wx.createPage(a);
