"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("manage-popup")+e.resolveComponent("floatButton"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/manage-popup/manage-popup.js")+(()=>"../../components/floatButton/floatButton.js"))();const o={__name:"cateManage",setup(o){const t=e.nr.importObject("cateWx",{customUI:!0});e.nr.importObject("qiniuyunCloud",{customUI:!0});const i=e.ref([]),a=e.ref(!1),n=e.ref(!1),l=e.ref(0),s=e.ref(0),r=e.ref("cateScrollView"),c=e.ref(!1),u=async()=>{if(!a.value){a.value=!0;try{const o=await t.get(null,!0);o&&o.data&&Array.isArray(o.data)?i.value=o.data.filter((e=>e&&"object"==typeof e)):(i.value=[],console.warn("获取到的分类数据不是有效的数组")),n.value=!0,e.nextTick$1((()=>{s.value>0?v(s.value):d()}))}catch(o){console.error("获取分类列表失败:",o),i.value=[],e.index.showToast({title:"获取分类失败",icon:"none"})}finally{a.value=!1}}},d=()=>{l.value=0,s.value=0},v=e=>{l.value=e},h=e=>{s.value=e.detail.scrollTop};e.onShow((()=>{n.value||u()})),e.onMounted((()=>{u();try{const o=e.index.getWindowInfo();S.value={windowWidth:o.windowWidth,windowHeight:o.windowHeight,rpxRatio:750/o.windowWidth}}catch(o){console.error("获取设备信息失败:",o);try{const o=e.index.getSystemInfoSync();S.value={windowWidth:o.windowWidth,windowHeight:o.windowHeight,rpxRatio:750/o.windowWidth}}catch(t){console.error("获取系统信息失败:",t)}}}));const f=e.ref(!1),w=e.ref(!1),m=e.ref(""),g=e.ref(""),p=e.ref(""),x=e.ref(!1),_=e.ref(0),y=e.ref(!0),b=e.ref(!1),T=e.ref(-1),L=e.ref(0),$=e.ref(0),M=e.ref(0),I=e.ref(0),k=e.ref(!1),P=e.ref(90),S=e.ref({windowWidth:375,windowHeight:667,rpxRatio:2}),j=e.ref(!1),z=e.ref(!1),W=e.ref({}),C=e.computed((()=>{if(!j.value||!i.value||0===i.value.length)return[];return[...i.value.map(((e,o)=>({...e,originalIndex:o,sortValue:void 0!==W.value[e._id]?Number(W.value[e._id]):void 0!==e.sort_order?Number(e.sort_order):0})))].sort(((e,o)=>o.sortValue-e.sortValue))})),N=(e,o)=>{W.value[e]||(W.value[e]=0);let t=Number(W.value[e])||0;t+=o,t=Math.max(0,t),W.value[e]=t},F={},D=e.computed((()=>i.value&&0!==i.value.length?[...i.value].sort(((e,o)=>{const t=void 0!==e.sort_order?Number(e.sort_order):0;return(void 0!==o.sort_order?Number(o.sort_order):0)-t})):[])),E=()=>{j.value=!j.value,j.value?(W.value={},D.value.forEach(((e,o)=>{const t=void 0!==e.sort_order?e.sort_order:D.value.length-o;W.value[e._id]=t})),z.value=!1,e.index.showToast({title:"进入序号排序模式",icon:"none",duration:2e3})):Object.keys(F).forEach((e=>{clearTimeout(F[e])}))},R=async()=>{try{e.index.showLoading({title:"保存中...",mask:!0});const o=Object.entries(W.value).map((([e,o])=>t.updateSort(e,Number(o))));await Promise.all(o),e.index.hideLoading(),e.index.showToast({title:"排序已保存",icon:"success"}),await u(),j.value=!1}catch(o){console.error("保存排序失败:",o),e.index.hideLoading(),e.index.showToast({title:"保存排序失败",icon:"none"})}},H=()=>{j.value=!1,z.value=!1,e.index.showToast({title:"已取消序号排序",icon:"none"})},O=(e,o)=>{let t=Number(o);isNaN(t)&&(t=0),W.value[e]=t},q=o=>{if(-1===T.value||!k.value||!i.value||0===i.value.length||!b.value)return;const t=o.touches&&o.touches[0];if(!t)return;const a=t.pageY;$.value=a;const n=a-M.value;if(Math.abs(n)<5)return;const l=P.value/S.value.rpxRatio;e.index.nextTick((()=>{e.index.createSelectorQuery().select(".drag-list").boundingClientRect((o=>{if(!o)return;const t=a-o.top;let n=Math.floor(t/l);if(n=Math.max(0,Math.min(i.value.length-1,n)),n!==T.value){const o=i.value[T.value];if(!o)return;const t=[...i.value];t.splice(T.value,1),t.splice(n,0,o),i.value=t,T.value=n;try{e.index.vibrateShort&&e.index.vibrateShort({success:()=>{},fail:()=>{}})}catch(s){}M.value=a}})).exec()}))},U=async()=>{if(k.value&&T.value>=0){try{e.index.vibrateShort&&e.index.vibrateShort({success:()=>{},fail:()=>{}})}catch(o){}e.index.showLoading({title:"保存中...",mask:!1}),setTimeout((async()=>{try{const o=i.value.map(((e,o)=>{const a=i.value.length-o;return t.updateSort(e._id,a)}));await Promise.all(o),e.index.hideLoading(),e.index.showToast({title:"排序已自动保存",icon:"success",duration:1500})}catch(o){console.error("自动保存排序失败:",o),e.index.hideLoading(),e.index.showToast({title:"保存排序失败，请重试",icon:"none"})}}),200)}T.value=-1,k.value=!1},A=()=>{console.log(1),w.value=!1,p.value="",m.value="",y.value=!0,f.value=!0},B=async()=>{try{const o=await e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(o.tempFilePaths&&o.tempFilePaths.length>0){const e=o.tempFilePaths[0];await V(e)}}catch(o){console.error("选择图片失败:",o),"chooseImage:fail cancel"!==o.errMsg&&e.index.showToast({title:"选择图片失败",icon:"none"})}},V=async o=>{try{x.value=!0,_.value=0;const t=await new Promise(((t,i)=>{e.index.getFileInfo({filePath:o,success:e=>t(e),fail:e=>i(e)})}));let i=o;t.size>1048576&&(i=await new Promise(((t,i)=>{e.index.compressImage({src:o,quality:80,success:e=>t(e.tempFilePath),fail:e=>i(e)})})));const a=i.substring(i.lastIndexOf(".")+1).toLowerCase(),n=Date.now(),l=`cate_icons/${n}_${Math.random().toString(36).substring(2,10)}.${a}`,s=await e.nr.uploadFile({filePath:i,cloudPath:l,onUploadProgress:e=>{_.value=Math.round(e.loaded/e.total*100)}});if(console.log("上传结果:",s),!s.fileID)throw new Error("上传失败");{const o=await e.nr.getTempFileURL({fileList:[s.fileID]});if(console.log("临时链接:",o),!(o.fileList&&o.fileList[0]&&o.fileList[0].tempFileURL))throw new Error("获取临时链接失败");p.value=s.fileID,e.index.showToast({title:"图片上传成功",icon:"success"})}}catch(t){console.error("上传图片错误:",t),e.index.showToast({title:"图片上传失败: "+(t.message||"未知错误"),icon:"none"})}finally{x.value=!1}},Y=async o=>{if(x.value)e.index.showToast({title:"图片正在上传中，请稍候",icon:"none"});else{if("string"==typeof o?o={cate_name:o,cate_img:p.value,is_visible:y.value}:!o.cate_img&&p.value&&(o.cate_img=p.value),w.value){console.log("编辑",o);const i=await t.update(g.value,o);console.log(i),1===i.updated&&(e.index.showToast({title:"更新成功",icon:"none"}),u())}else{console.log("添加",o);(await t.add(o)).id&&(e.index.showToast({title:"添加成功",icon:"none"}),u())}g.value="",p.value=""}},G=()=>{f.value=!1},J=()=>{b.value?(b.value=!1,e.index.showToast({title:"已退出排序模式",icon:"none"})):(b.value=!0,e.index.showToast({title:"上下滑动排序分类，拖动后自动保存",icon:"none",duration:2500}))},K=e=>e&&"undefined"!==e&&"null"!==e&&(e.startsWith("cloud://")||e.startsWith("/static/")||e.startsWith("http")||e.startsWith("/"))?e:"/static/images/default.png",Q=(e,o)=>{e&&(console.warn("图片加载失败:",o),e.cate_img="/static/images/default.png")},X=async()=>{if(c.value)return;if(!i.value||0===i.value.length)return void e.index.showToast({title:"没有可隐藏的分类",icon:"none"});const o=i.value.filter((e=>e&&!1!==e.is_visible));0!==o.length?e.index.showModal({title:"确认隐藏",content:`是否隐藏所有分类？将有 ${o.length} 个分类被隐藏，隐藏后分类将不会在前台显示。`,confirmText:"隐藏全部",confirmColor:"#399bfe",cancelText:"取消",success:async i=>{if(i.confirm)try{c.value=!0,e.index.showLoading({title:"处理中...",mask:!0});const i=10;let a=0;const n=o.length;for(let l=0;l<n;l+=i){const s=o.slice(l,l+i);e.index.showLoading({title:`处理中 ${l+1}-${Math.min(l+i,n)}/${n}...`,mask:!0});const r=s.map((e=>t.update(e._id,{is_visible:!1}).then((()=>a++)).catch((o=>(console.error(`更新分类 ${e._id} 失败:`,o),null)))));await Promise.all(r)}e.index.hideLoading(),a===n?e.index.showToast({title:`已隐藏全部 ${a} 个分类`,icon:"success",duration:2e3}):e.index.showModal({title:"操作结果",content:`成功隐藏 ${a}/${n} 个分类，部分操作可能失败，请刷新后检查。`,showCancel:!1,confirmText:"确定"}),await u()}catch(a){console.error("批量隐藏分类失败:",a),e.index.hideLoading(),e.index.showToast({title:"操作失败，请重试",icon:"none"})}finally{c.value=!1}}}):e.index.showToast({title:"所有分类已经是隐藏状态",icon:"none"})},Z=async()=>{if(c.value)return;if(!i.value||0===i.value.length)return void e.index.showToast({title:"没有可显示的分类",icon:"none"});const o=i.value.filter((e=>e&&!1===e.is_visible));0!==o.length?e.index.showModal({title:"确认显示",content:`是否显示所有分类？将有 ${o.length} 个分类被显示，显示后分类将会在前台可见。`,confirmText:"显示全部",confirmColor:"#399bfe",cancelText:"取消",success:async i=>{if(i.confirm)try{c.value=!0,e.index.showLoading({title:"处理中...",mask:!0});const i=10;let a=0;const n=o.length;for(let l=0;l<n;l+=i){const s=o.slice(l,l+i);e.index.showLoading({title:`处理中 ${l+1}-${Math.min(l+i,n)}/${n}...`,mask:!0});const r=s.map((e=>t.update(e._id,{is_visible:!0}).then((()=>a++)).catch((o=>(console.error(`更新分类 ${e._id} 失败:`,o),null)))));await Promise.all(r)}e.index.hideLoading(),a===n?e.index.showToast({title:`已显示全部 ${a} 个分类`,icon:"success",duration:2e3}):e.index.showModal({title:"操作结果",content:`成功显示 ${a}/${n} 个分类，部分操作可能失败，请刷新后检查。`,showCancel:!1,confirmText:"确定"}),await u()}catch(a){console.error("批量显示分类失败:",a),e.index.hideLoading(),e.index.showToast({title:"操作失败，请重试",icon:"none"})}finally{c.value=!1}}}):e.index.showToast({title:"所有分类已经是显示状态",icon:"none"})};return(o,n)=>e.e({a:j.value?1:"",b:e.o(E),c:e.t(b.value?"退出排序":"滑动排序"),d:b.value?1:"",e:e.o(J),f:!a.value&&i.value.length>0&&!b.value&&!j.value},!a.value&&i.value.length>0&&!b.value&&!j.value?{g:e.p({type:"eye-filled",size:"18",color:"#399bfe"}),h:e.o(Z),i:e.p({type:"eye-slash-filled",size:"18",color:"#666"}),j:e.o(X)}:{},{k:a.value},a.value?{l:e.p({type:"spinner-cycle",size:"30",color:"#399bfe"})}:0===i.value.length?{n:e.p({type:"info",size:"50",color:"#999"})}:e.e({o:j.value},j.value?e.e({p:e.o(H),q:e.o(R),r:C.value.length>0},(C.value.length,{}),{s:e.f(C.value,((o,t,i)=>e.e({a:K(o&&o.cate_img),b:e.o((e=>Q(o,e)),o._id),c:e.o((()=>{}),o._id),d:e.t(o?o.cate_name:""),e:o&&!o.is_visible},(o&&o.is_visible,{}),{f:o,g:o.is_visible?"":1,h:"df3c1365-4-"+i,i:e.o((e=>N(o._id,-1)),o._id),j:W.value[o._id],k:e.o((e=>{return t=o._id,i=e.detail.value,F[t]&&clearTimeout(F[t]),void(F[t]=setTimeout((()=>{O(t,i)}),200));var t,i}),o._id),l:"df3c1365-5-"+i,m:e.o((e=>N(o._id,1)),o._id),n:o._id}))),t:e.p({type:"minus",size:"20",color:"#666"}),v:e.p({type:"plus",size:"20",color:"#399bfe"})}):b.value?{A:e.f(i.value,((o,t,a)=>e.e({a:K(o&&o.cate_img),b:e.o((e=>Q(o,e)),o&&o._id?o._id:t),c:e.o((()=>{}),o&&o._id?o._id:t),d:e.t(o?o.cate_name:""),e:o&&!o.is_visible},(o&&o.is_visible,{}),{f:o,g:o&&!o.is_visible?1:"",h:"df3c1365-8-"+a,i:T.value===t?1:"",j:o&&o._id?o._id:t,k:t*P.value,l:T.value===t?10:1,m:T.value===t?"none":"transform 0.3s ease, background-color 0.2s ease",n:T.value===t?"scale(1.02)":"scale(1)",o:T.value!==t,p:e.o((o=>((o,t)=>{if(!i.value||0===i.value.length||!b.value)return;const a=t.touches&&t.touches[0];if(!a)return;i.value[o]&&(-1!==T.value&&T.value!==o&&U(),T.value=o,M.value=a.pageY,L.value=a.pageY,I.value=o*P.value,k.value=!0,setTimeout((()=>{try{e.index.vibrateShort&&e.index.vibrateShort({success:()=>{},fail:()=>{}})}catch(o){}}),50))})(t,o)),o&&o._id?o._id:t),q:e.o(q,o&&o._id?o._id:t),r:e.o(U,o&&o._id?o._id:t),s:e.o(U,o&&o._id?o._id:t),t:T.value===t?1:""}))),B:e.p({type:"bars",size:"22",color:"#999"}),C:P.value+"rpx",D:i.value.length*P.value+"rpx"}:{x:e.f(D.value,((o,i,a)=>e.e({a:e.t(o.sort_order||D.value.length-i),b:K(o&&o.cate_img),c:e.o((e=>Q(o,e)),o._id),d:e.o((()=>{}),o._id),e:e.t(o?o.cate_name:""),f:o&&!o.is_visible},(o&&o.is_visible,{}),{g:o,h:o.is_visible?"":1,i:o&&!1!==o.is_visible,j:e.o((()=>(async(o,i)=>{if(!o)return console.error("切换可见性失败：无效的ID"),void e.index.showToast({title:"操作失败",icon:"none"});const a=!i;try{const i=await t.update(o,{is_visible:a});if(!i||1!==i.updated)throw new Error("切换可见性更新失败");e.index.showToast({title:a?"已启用显示":"已隐藏分类",icon:"none"}),u()}catch(n){console.error("切换可见性失败:",n),e.index.showToast({title:"操作失败，请重试",icon:"none"})}})(o._id,o&&!1!==o.is_visible)),o._id),k:e.o((i=>(async o=>{var i,a,n;if(!o)return console.error("编辑分类失败：无效的ID"),void e.index.showToast({title:"操作失败",icon:"none"});try{w.value=!0,g.value=o;const e=await t.get(o);if(!(e&&e.data&&e.data[0]))throw new Error("获取分类详情失败");console.log(e,"单个获取"),m.value=(null==(i=e.data[0])?void 0:i.cate_name)||"",p.value=(null==(a=e.data[0])?void 0:a.cate_img)||"",y.value=!1!==(null==(n=e.data[0])?void 0:n.is_visible),f.value=!0}catch(l){console.error("获取分类信息失败:",l),e.index.showToast({title:"获取分类信息失败",icon:"none"}),w.value=!1,g.value=""}})(o._id)),o._id),l:"df3c1365-6-"+a,m:e.o((i=>(async o=>{if(!o)return console.error("删除分类失败：无效的ID"),void e.index.showToast({title:"操作失败",icon:"none"});e.index.showModal({title:"确认删除",content:"是否确认删除该分类？删除后无法恢复",confirmText:"删除",confirmColor:"#ff0000",cancelText:"取消",success:async i=>{if(i.confirm)try{e.index.showLoading({title:"删除中...",mask:!0});const i=await t.del(o);if(e.index.hideLoading(),!i||1!==i.deleted)throw new Error("删除失败");e.index.showToast({title:"删除成功",icon:"success"}),await u()}catch(a){e.index.hideLoading(),console.error("删除失败:",a),e.index.showToast({title:"删除失败: "+(a.message||"未知错误"),icon:"none"})}}})})(o._id)),o._id),n:"df3c1365-7-"+a,o:o._id}))),y:e.p({color:"#399bfe",type:"compose",size:"22"}),z:e.p({color:"#e65c00","custom-prefix":"iconfont",type:"icon-shanchu1",size:"20"})},{w:!b.value,E:b.value?1:"",F:j.value?1:"",G:l.value,H:e.o(h),I:r.value}),{m:0===i.value.length,J:e.o(B),K:e.o(Y),L:e.o(G),M:e.p({show:f.value,title:w.value?"编辑分类":"添加分类","edit-value":m.value,"image-url":p.value,"image-uploading":x.value,"upload-progress":_.value,"is-visible":y.value}),N:e.o(A),O:e.p({icon:"plus",size:100,position:{bottom:"120rpx",right:"40rpx"}})})}},t=e._export_sfc(o,[["__scopeId","data-v-df3c1365"]]);wx.createPage(t);
